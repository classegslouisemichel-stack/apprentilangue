<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Apprentilangue</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìñ</text></svg>">
<style>
@font-face{font-family:'Cursive Dumont maternelle';src:url('cursive.otf') format('opentype');}
@font-face{font-family:'MDIEcole';src:url('MDIecole-Regular.otf') format('opentype'),url('mdi_ecole.ttf') format('truetype');}
:root{--cp:#8b7355;--cpd:#5c4a2a;--cpl:#f2ead8;--fn:'MDIEcole','Calibri',Arial,sans-serif;}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:var(--fn);background:#e8e4d8;min-height:100vh;}
/* NAV */
#nav{background:var(--cpd);color:#fff;display:flex;align-items:center;gap:10px;padding:0 18px;position:fixed;top:0;left:0;right:0;z-index:100;height:50px;}
#nav h1{font-size:18px;font-weight:700;flex:1;}
.nb{background:rgba(255,255,255,.15);color:#fff;border:none;padding:5px 14px;border-radius:18px;cursor:pointer;font-size:13px;font-family:var(--fn);}
.nb:hover,.nb.active{background:rgba(255,255,255,.3);}
#app{margin-top:50px;}
/* PAGES */
.pg{display:none;}.pg.on{display:block;}
/* HOME */
#pg-home{padding:26px;max-width:920px;margin:0 auto;}
#pg-home h2{font-size:21px;margin-bottom:16px;color:var(--cpd);}
.sg{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:14px;margin-bottom:22px;}
.sc{background:#fff;border-radius:10px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,.1);border-left:5px solid var(--cp);}
.sc h3{font-size:16px;color:var(--cpd);}
.sc p{font-size:12px;color:#777;margin-top:3px;}
.scb{display:flex;gap:7px;margin-top:10px;flex-wrap:wrap;}
/* EDITOR */
#pg-editor{padding:18px 24px;max-width:1100px;margin:0 auto;}
.eh{display:flex;align-items:center;gap:10px;margin-bottom:16px;flex-wrap:wrap;}
.eh h2{font-size:18px;color:var(--cpd);flex:1;}
.wl{display:grid;grid-template-columns:repeat(auto-fill,minmax(290px,1fr));gap:9px;}
.wc{background:#fff;border-radius:8px;padding:10px 13px;box-shadow:0 1px 4px rgba(0,0,0,.07);border-left:4px solid var(--cpl);display:flex;align-items:center;justify-content:space-between;}
.wc:hover{border-left-color:var(--cp);}
/* SETTINGS */
#pg-settings{padding:24px;max-width:1000px;margin:0 auto;}
#pg-settings h2{font-size:20px;color:var(--cpd);margin-bottom:18px;}
.ss{background:#fff;border-radius:10px;padding:16px;margin-bottom:16px;box-shadow:0 1px 5px rgba(0,0,0,.07);}
.ss h3{font-size:14px;color:#444;margin-bottom:12px;border-bottom:1px solid #eee;padding-bottom:6px;}
/* BUTTONS */
.btn{background:var(--cp);color:#fff;border:none;padding:8px 16px;border-radius:7px;cursor:pointer;font-size:13px;font-weight:600;font-family:var(--fn);}
.btn:hover{filter:brightness(.9);}
.bsm{padding:5px 11px;font-size:12px;}
.bo{background:#eee;color:#444;border:1px solid #ccc;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:12px;font-family:var(--fn);}
.bo:hover{border-color:var(--cp);}
.bd{background:#e05a5a;color:#fff;border:none;padding:5px 10px;border-radius:6px;cursor:pointer;font-size:12px;font-family:var(--fn);}
.bor{background:#e07a30;}
/* MODALS */
.mo{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:200;align-items:center;justify-content:center;pointer-events:none;}
.mo.on{display:flex;pointer-events:auto;}
.mb{background:#fff;border-radius:12px;padding:22px;width:96%;max-width:880px;max-height:92vh;overflow-y:auto;box-shadow:0 12px 40px rgba(0,0,0,.25);}
.mb h3{font-size:17px;margin-bottom:16px;color:var(--cpd);}
.fr{display:flex;gap:12px;margin-bottom:10px;align-items:flex-start;flex-wrap:wrap;}
.fg{display:flex;flex-direction:column;gap:3px;flex:1;min-width:100px;}
.fg label{font-size:11px;font-weight:700;color:#555;text-transform:uppercase;letter-spacing:.4px;}
.fg input,.fg textarea,.fg select{border:1px solid #ddd;border-radius:6px;padding:6px 9px;font-size:13px;font-family:var(--fn);}
.fg input:focus,.fg textarea:focus,.fg select:focus{outline:none;border-color:var(--cp);}
.fg textarea{resize:vertical;min-height:60px;}
.mf{display:flex;gap:9px;justify-content:flex-end;margin-top:16px;padding-top:12px;border-top:1px solid #eee;}
/* PHONETIC EDITOR */
.phs{margin-top:12px;border:1px solid #eee;border-radius:8px;padding:12px;background:#fafafa;}
.phs h4{font-size:13px;color:#555;margin-bottom:10px;}
.phr{display:flex;align-items:center;gap:7px;padding:5px 4px;border-bottom:1px solid #f0f0f0;flex-wrap:wrap;background:#fff;border-radius:4px;margin-bottom:3px;}
.phl{font-size:18px;font-weight:700;min-width:44px;}
.phs-in{border:1px solid #ddd;border-radius:4px;padding:3px 6px;font-size:12px;font-family:var(--fn);}
.lcs{display:flex;gap:5px;align-items:flex-end;}
.lcg{display:flex;flex-direction:column;align-items:center;gap:2px;}
.lcl{font-size:10px;font-weight:700;color:#666;}
.pds{display:flex;gap:2px;}
.pd{width:18px;height:18px;border-radius:4px;cursor:pointer;border:2px solid transparent;}
.pd:hover{border-color:#555;}
.pd.sel{border-color:#222;box-shadow:0 0 0 1px #fff inset;}
.phb{background:#f0f0f0;border:1px solid #ddd;border-radius:4px;padding:2px 8px;cursor:pointer;font-size:11px;}
.phb:hover{background:#e4e4e4;}
/* DICT TABLE */
.dt{width:100%;border-collapse:collapse;font-size:12px;}
.dt th{background:var(--cpl);padding:5px 8px;text-align:left;position:sticky;top:0;z-index:1;}
.dt td{padding:4px 7px;border-bottom:1px solid #f0f0f0;vertical-align:middle;}
.dt input{border:1px solid #ddd;border-radius:3px;padding:2px 5px;font-size:11px;font-family:var(--fn);}
.dt select{border:1px solid #ddd;border-radius:3px;padding:2px 4px;font-size:10px;font-family:var(--fn);}
/* METHOD TOGGLE */
.mt{display:flex;border:2px solid var(--cp);border-radius:8px;overflow:hidden;margin-top:4px;}
.mtb{flex:1;padding:6px 10px;border:none;cursor:pointer;font-size:12px;font-weight:600;font-family:var(--fn);background:#fff;color:#666;}
.mtb.on{background:var(--cp);color:#fff;}
/* BADGE */
.mbg{display:inline-block;padding:1px 7px;border-radius:9px;font-size:10px;font-weight:700;margin-left:5px;vertical-align:middle;}
.beo{background:#7ab648;color:#fff;}
.bbm{background:#4a90d9;color:#fff;}
/* COLOR ROW */
.cr{display:flex;align-items:center;gap:10px;margin-bottom:8px;}
.cr label{flex:1;font-size:13px;}
/* TOAST */
.toast{position:fixed;bottom:20px;right:20px;background:#333;color:#fff;padding:10px 16px;border-radius:8px;z-index:9999;font-size:13px;opacity:0;transition:opacity .3s;pointer-events:none;}
.toast.show{opacity:1;}

/* ===== SLIDESHOW ===== */
#ss-wrap{display:none;position:fixed;inset:0;z-index:500;background:#222;flex-direction:column;}
#ss-wrap.on{display:flex;}
#ss-stage{position:relative;flex:1;overflow:hidden;}
#ss-nav{background:var(--cpd);padding:6px 16px;display:flex;align-items:center;justify-content:space-between;gap:8px;flex-shrink:0;}
.sn{background:rgba(255,255,255,.15);color:#fff;border:none;padding:4px 12px;border-radius:16px;cursor:pointer;font-size:12px;font-family:var(--fn);}
.sn:hover{background:rgba(255,255,255,.28);}
.ci{color:rgba(255,255,255,.6);font-size:11px;text-align:center;flex:1;}
/* SLIDES */
.slide{display:none;position:absolute;inset:0;flex-direction:column;background:#f9f7ee;}
.slide.on{display:flex;}
.sh{background:var(--cp);color:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 22px;font-weight:700;font-size:20px;height:58px;flex-shrink:0;}
.grass{height:20px;flex-shrink:0;overflow:hidden;}
.grass svg{width:100%;height:20px;display:block;}
/* TITLE SLIDE */
.sl-title{background:#fff;align-items:center;justify-content:center;flex-direction:column;}
.sl-title h1{font-size:60px;font-weight:900;color:var(--cpd);letter-spacing:3px;}
.sl-title h2{font-size:38px;color:var(--cp);margin-top:12px;font-weight:400;}
/* SOMMAIRE */
.sl-som{background:#f9f7ee;}
.som-grid{flex:1;padding:12px 20px;display:grid;grid-template-columns:repeat(4,1fr);gap:6px;overflow-y:auto;}
.som-item{background:#fff;border:1.5px solid var(--cpl);border-radius:8px;padding:10px 14px;cursor:pointer;display:flex;gap:8px;align-items:center;font-size:17px;}
.som-item:hover{background:var(--cpl);}
.som-num{font-weight:700;color:var(--cpd);width:20px;}
/* SLIDE A */
.sab{flex:1;display:flex;flex-direction:column;padding:10px 18px 6px;overflow:hidden;position:relative;}
.def-box{background:#fff;border:2px solid var(--cpl);border-radius:7px;padding:12px 16px;font-size:18px;color:#333;line-height:1.6;margin-bottom:10px;min-height:56px;}
.def-line{display:none;}.def-line.on{display:block;}
.wi{position:absolute;top:4px;right:10px;width:160px;height:140px;object-fit:contain;display:none;border-radius:10px;border:3px solid var(--cpl);background:#fff;padding:3px;box-shadow:0 2px 8px rgba(0,0,0,.12);}
.wi.on{display:block;}
.wz{flex:1;display:flex;align-items:center;justify-content:center;padding-right:180px;}
/* D√©cor th√®me : images centr√©es dans le bandeau uniquement */
.sh-decos{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);display:flex;gap:8px;align-items:center;pointer-events:none;}
.sh-decos img{height:42px;width:auto;opacity:.9;filter:drop-shadow(0 1px 2px rgba(0,0,0,.2));}
.sh{position:relative;}
/* LETTERS ROW */
.lr{display:flex;align-items:flex-end;gap:0;}
.ssep{width:3px;border-right:3px dashed #82c4e0;height:190px;margin:0 6px;align-self:flex-end;margin-bottom:-70px;}
.pg-grp{display:inline-flex;align-items:flex-end;position:relative;}
.ls{display:flex;flex-direction:column;align-items:center;width:72px;}
.lc{font-size:70px;font-weight:700;height:82px;display:flex;align-items:flex-end;justify-content:center;opacity:0;transition:opacity .22s;line-height:1;}
.lc.on{opacity:1;}
.lb{width:56px;height:5px;border-radius:2px;margin:4px auto 0;}
/* Point de liaison : centr√© sur le trait, d√©borde dessus et dessous */
.dw{position:relative;width:0;height:0;align-self:flex-end;margin-bottom:4px;}
.ld{position:absolute;width:20px;height:20px;border-radius:50%;
    left:50%;top:50%;transform:translate(-50%,-50%);
    margin-top:-2px; /* centr√© sur le trait de 5px */
    z-index:2;}
/* Sound image ‚Äî one per group, centered */
.si{width:68px;height:68px;object-fit:contain;opacity:0;transition:opacity .22s;position:absolute;left:50%;transform:translateX(-50%);bottom:-74px;pointer-events:none;}
.si.on{opacity:1;}
/* SLIDE B */
.sbb{flex:1;display:flex;flex-direction:column;padding:10px 18px 6px;gap:10px;}
.wa{display:flex;flex:1;gap:12px;align-items:stretch;min-height:0;}
.wcv{flex:1.4;display:flex;align-items:center;justify-content:center;background:#fff;border:2px solid var(--cpl);border-radius:7px;font-family:'Cursive Dumont maternelle',serif;font-size:100px;color:#222;padding:10px;text-align:center;min-width:0;overflow:hidden;}
.wr{flex:.85;display:flex;flex-direction:column;gap:8px;}
.wca{flex:1;display:flex;align-items:center;justify-content:center;background:#fff;border:2px solid var(--cpl);border-radius:7px;font-size:42px;font-weight:700;color:#222;letter-spacing:2px;}
.wsc{flex:1;display:flex;align-items:center;justify-content:center;background:#fff;border:2px solid var(--cpl);border-radius:7px;font-size:32px;color:#222;}
.wib{flex-shrink:0;width:140px;object-fit:contain;border:2px solid var(--cpl);border-radius:7px;background:#fff;padding:3px;}
.sb-cat-label{font-size:11px;font-weight:700;color:#aaa;letter-spacing:2px;text-transform:uppercase;margin-bottom:2px;width:100%;text-align:left;padding-left:4px;}
.gb{background:var(--cpl);border-radius:7px;padding:12px 20px;display:flex;gap:40px;align-items:center;}
.nb2{background:#f0f0f0;border-radius:7px;padding:12px 20px;display:flex;gap:30px;align-items:center;flex-wrap:wrap;}
.ci2{display:flex;align-items:center;gap:10px;font-size:20px;font-weight:700;}
.cb{width:30px;height:30px;border:2px solid #aaa;border-radius:5px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;}
.cb.ok{background:#4CAF50;border-color:#4CAF50;color:#fff;}
.cb.nope{border-color:#e8002a;color:#e8002a;background:#fff0f0;font-size:20px;}
.cb.ko{background:#e8002a;color:#fff;font-size:14px;display:flex;align-items:center;justify-content:center;}

/* ‚îÄ‚îÄ GUIDE UTILISATEUR ‚îÄ‚îÄ */
.guide-content{font-size:14px;line-height:1.7;color:#333;}
.guide-content h3{font-size:15px;font-weight:700;color:var(--cpd);margin:22px 0 8px;padding-bottom:4px;border-bottom:2px solid var(--cpl);}
.guide-content p{margin:6px 0 10px;}
.guide-content ol,.guide-content ul{margin:6px 0 10px;padding-left:20px;}
.guide-content li{margin-bottom:4px;}
.guide-content strong{color:#333;}
.guide-content code{background:#f0ede8;padding:1px 5px;border-radius:3px;font-size:12px;font-family:monospace;}
.guide-tip{background:#fef9e7;border-left:3px solid #f0c040;padding:10px 14px;border-radius:0 6px 6px 0;margin:10px 0;font-size:13px;color:#555;}
.guide-table{width:100%;border-collapse:collapse;margin:10px 0 14px;font-size:13px;}
.guide-table th{background:var(--cpl);color:var(--cpd);padding:7px 10px;text-align:left;font-weight:600;}
.guide-table td{padding:6px 10px;border-bottom:1px solid #eee;}
.guide-table tr:last-child td{border-bottom:none;}
.guide-faq{display:flex;flex-direction:column;gap:0;}
.guide-q{background:var(--cpl);color:var(--cpd);padding:8px 12px;font-weight:600;font-size:13px;margin-top:8px;border-radius:6px 6px 0 0;}
.guide-a{background:#faf8f4;padding:8px 12px;font-size:13px;color:#555;border-radius:0 0 6px 6px;border:1px solid var(--cpl);border-top:none;}
kbd{background:#eee;border:1px solid #ccc;border-radius:3px;padding:1px 6px;font-size:12px;font-family:monospace;}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
<nav id="nav">
  <h1>üìñ Apprentilangue</h1>
  <button class="nb active" onclick="goPage('home')">üìö S√©ries</button>
  <button class="nb" onclick="goPage('settings')">‚öôÔ∏è Param√®tres</button>
  <button class="nb" onclick="openExportModal()" title="Exporter / Partager">‚¨áÔ∏è Export</button>
  <button class="nb" onclick="openImportModal()" title="Importer s√©ries ou mots">‚¨ÜÔ∏è Import</button>
  <button class="nb" onclick="openGuide()" title="Guide utilisateur">‚ùì Aide</button>
</nav>
<div id="app">

<div id="pg-home" class="pg on">
  <h2>Mes s√©ries de vocabulaire</h2>
  <div class="sg" id="series-grid"></div>
  <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
    <button class="btn" type="button" onclick="openNewSeriesModal()">+ Nouvelle s√©rie</button>
    <a class="btn" style="text-decoration:none;padding:8px 16px" href="modele_import.xlsx" download>üì• Mod√®le Excel</a>
  </div>
</div>

<div id="pg-editor" class="pg">
  <div class="eh">
    <button class="bo" type="button" onclick="goPage('home')">‚Üê Retour</button>
    <h2 id="editor-title">√âditer</h2>
    <button class="bo bsm" type="button" onclick="openSeriesSettingsModal()">‚öôÔ∏è S√©rie</button>
    <button class="btn bsm" type="button" onclick="openAddWordModal()">+ Mot</button>
    <button class="btn bsm bor" type="button" onclick="launchSS()">‚ñ∂ Diaporama</button>
  </div>
  <div class="wl" id="words-list"></div>
</div>

<div id="pg-settings" class="pg">
  <h2>‚öôÔ∏è Param√®tres globaux</h2>
  <div class="ss">
    <h3>üé® Couleurs</h3>
    <div class="cr"><label>Principale</label><input type="color" id="col-p" value="#7ab648" oninput="liveCol()"></div>
    <div class="cr"><label>Secondaire</label><input type="color" id="col-pl" value="#d4edaa" oninput="liveCol()"></div>
    <div class="cr"><label>Sombre</label><input type="color" id="col-pd" value="#5a8a30" oninput="liveCol()"></div>
  </div>
  <div class="ss">
    <h3>üìÇ Dossier images</h3>
    <div class="fg" style="max-width:320px"><label>Chemin</label><input type="text" id="img-folder" value="images/"></div>
    <p style="font-size:11px;color:#888;margin-top:6px">‚Ä¢ Sons EO : <code>images/eo/a-avion.png</code> etc.<br>‚Ä¢ Gestes BM : <code>images/borel/a.png</code> etc.</p>
  </div>
  <div class="ss">
    <h3>üìñ Dictionnaire ‚Äî <span style="color:#5a8a30">üìó Enthousiasme Orthographique</span></h3>
    <div style="max-height:380px;overflow-y:auto;border:1px solid #eee;border-radius:6px;"><table class="dt" id="tbl-eo"></table></div>
    <div style="margin-top:8px"><button class="bo bsm" type="button" onclick="addEntry('eo')">+ Ajouter un graph√®me</button></div>
  </div>
  <div class="ss">
    <h3>üìñ Dictionnaire ‚Äî <span style="color:#4a90d9">üìò Borel-Maisonny</span></h3>
    <div style="max-height:380px;overflow-y:auto;border:1px solid #eee;border-radius:6px;"><table class="dt" id="tbl-bm"></table></div>
    <div style="margin-top:8px"><button class="bo bsm" type="button" onclick="addEntry('bm')">+ Ajouter un graph√®me</button></div>
  </div>
  <div style="display:flex;gap:10px;margin-top:4px">
    <button class="btn" type="button" onclick="saveSettings()">üíæ Enregistrer</button>
    <button class="bo" type="button" onclick="resetDicts()">‚Ü∫ R√©initialiser dicts</button>
  </div>
</div>

</div><!-- #app -->

<!-- SLIDESHOW -->
<div id="ss-wrap">
  <div id="ss-stage"></div>
  <div id="ss-nav">
    <div style="display:flex;gap:6px">
      <button class="sn" type="button" onclick="ssMenu()">üè† Menu</button>
      <button class="sn" type="button" onclick="ssBack2()">‚èÆ‚àí2</button>
      <button class="sn" type="button" onclick="ssBack()">‚óÄ</button>
    </div>
    <span class="ci" id="ss-hint">Cliquez pour r√©v√©ler</span>
    <div style="display:flex;gap:6px">
      <button class="sn" type="button" onclick="ssGoto(1)">üìã</button>
      <button class="sn" type="button" onclick="ssNextWord()">Mot‚è≠</button>
      <button class="sn" type="button" onclick="ssNext()">‚ñ∂</button>
    </div>
  </div>
</div>

<!-- MODAL: NEW SERIES -->

<!-- MODAL: LANCEMENT DIAPORAMA -->
<div class="mo" id="m-launch">
  <div class="mb" style="max-width:360px">
    <h3>Lancer le diaporama</h3>
    <div class="fg" style="margin-bottom:16px">
      <label style="margin-bottom:8px;display:block">Affichage des lettres</label>
      <div style="display:flex;flex-direction:column;gap:8px">
        <label style="display:flex;align-items:center;gap:10px;cursor:pointer;font-size:15px">
          <input type="radio" name="ss-casse" value="script" checked> <span style="font-size:22px;font-family:'MDIEcole',sans-serif">abc</span> Scriptes (MDI √âcole)
        </label>
        <label style="display:flex;align-items:center;gap:10px;cursor:pointer;font-size:15px">
          <input type="radio" name="ss-casse" value="upper"> <span style="font-size:22px;font-weight:700;letter-spacing:1px">ABC</span> Capitales
        </label>
        <label style="display:flex;align-items:center;gap:10px;cursor:pointer;font-size:15px">
          <input type="radio" name="ss-casse" value="cursive"> <span style="font-size:22px;font-family:'Cursive Dumont maternelle',cursive">abc</span> Cursive
        </label>
      </div>
    </div>
    <div class="mf">
      <button class="bo" type="button" onclick="closeModal('m-launch')">Annuler</button>
      <button class="btn bor" type="button" onclick="confirmLaunchSS()">‚ñ∂ Lancer</button>
    </div>
  </div>
</div>

<div class="mo" id="m-newseries">
  <div class="mb" style="max-width:420px">
    <h3>Nouvelle s√©rie</h3>
    <div class="fg" style="margin-bottom:12px"><label>Nom</label><input type="text" id="ns-name" placeholder="ex: Le Jardin"></div>
    <div class="fg" style="margin-bottom:12px"><label>Couleur</label><input type="color" id="ns-color" value="#8b7355"></div>
    <div class="fg" style="margin-bottom:12px"><label>Police</label>
      <select id="ns-font"><option value="MDIEcole">MDI √âcole</option><option value="Calibri">Calibri</option><option value="Arial">Arial</option><option value="Times New Roman">Times New Roman</option></select></div>
    <div class="fg" style="margin-bottom:4px"><label>M√©thode</label>
      <div class="mt"><button class="mtb on" type="button" id="ns-eo" onclick="setNsM('eo')">üìó Enthousiasme</button><button class="mtb" type="button" id="ns-bm" onclick="setNsM('bm')">üìò Borel-Maisonny</button></div>
    </div>
    <div class="fg" style="margin-bottom:4px"><label>üé® Images d√©coratives (chemins s√©par√©s par ;)</label>
      <input type="text" id="ns-decos" placeholder="images/deco/fleur.png;images/deco/feuille.png">
      <span style="font-size:10px;color:#888">Seront affich√©es dans le bandeau et en fond d'√©cran (semi-transparent)</span>
    </div>
    <div class="mf">
      <button class="bo" type="button" onclick="closeModal('m-newseries')">Annuler</button>
      <button class="btn" type="button" onclick="createSeries()">Cr√©er</button>
    </div>
  </div>
</div>

<!-- MODAL: SERIES SETTINGS -->
<div class="mo" id="m-series-settings">
  <div class="mb" style="max-width:420px">
    <h3>‚öôÔ∏è Param√®tres de la s√©rie</h3>
    <div class="fg" style="margin-bottom:12px"><label>Nom</label><input type="text" id="es-name"></div>
    <div class="fg" style="margin-bottom:12px"><label>Couleur</label><input type="color" id="es-color"></div>
    <div class="fg" style="margin-bottom:12px"><label>Police</label>
      <select id="es-font"><option value="MDIEcole">MDI √âcole</option><option value="Calibri">Calibri</option><option value="Arial">Arial</option><option value="Times New Roman">Times New Roman</option></select></div>
    <div class="fg" style="margin-bottom:4px"><label>M√©thode</label>
      <div class="mt"><button class="mtb on" type="button" id="es-eo" onclick="setEsM('eo')">üìó Enthousiasme</button><button class="mtb" type="button" id="es-bm" onclick="setEsM('bm')">üìò Borel-Maisonny</button></div>
    </div>
    <div class="fg" style="margin-bottom:4px"><label>üé® Images d√©coratives (chemins s√©par√©s par ;)</label>
      <input type="text" id="es-decos" placeholder="images/deco/fleur.png;images/deco/feuille.png">
      <span style="font-size:10px;color:#888">Seront affich√©es dans le bandeau et en fond d'√©cran</span>
    </div>
    <div class="mf">
      <button class="bo" type="button" onclick="closeModal('m-series-settings')">Annuler</button>
      <button class="btn" type="button" onclick="saveSeriesSettings()">üíæ Enregistrer</button>
    </div>
  </div>
</div>

<!-- MODAL: WORD -->
<div class="mo" id="m-word">
  <div class="mb">
    <h3 id="m-word-title">Mot</h3>
    <div class="fr">
      <div class="fg"><label>Mot</label><input type="text" id="f-word" oninput="onWordInput()" style="font-size:19px;font-weight:700;text-transform:uppercase"></div>
      <div class="fg"><label>Th√®me</label><input type="text" id="f-theme"></div>
      <div class="fg" style="flex:.35"><label>N¬∞</label><input type="number" id="f-num" min="1"></div>
      <div class="fg" style="flex:.35"><label>Total</label><input type="number" id="f-total" value="32"></div>
    </div>
    <div class="fr"><div class="fg"><label>D√©finition</label><textarea id="f-def"></textarea></div></div>
    <div class="fr">
      <div class="fg" style="flex:.45"><label>Genre</label><select id="f-gender"><option value="masc">Masculin</option><option value="fem">F√©minin</option><option value="both">Les deux</option><option value="none">Aucun</option></select></div>
      <div class="fg" style="flex:.45"><label>Nature</label><select id="f-nature"><option value="nom">NOM</option><option value="verbe">VERBE</option><option value="adjectif">ADJECTIF</option><option value="autre">AUTRE</option></select></div>
      <div class="fg"><label>Image</label><input type="text" id="f-img" placeholder="images/mot.png"></div>
    </div>
    <div style="display:flex;align-items:center;gap:10px;margin:8px 0;flex-wrap:wrap">
      <span style="font-size:11px;font-weight:700;color:#555;text-transform:uppercase">Syllabes :</span>
      <span id="syll-disp" style="font-size:13px;background:#f0f0f0;padding:2px 10px;border-radius:10px"></span>
      <button type="button" class="bo bsm" onclick="editSylls()">‚úèÔ∏è Modifier</button>
    </div>
    <div class="phs">
      <h4>üî§ Phon√©tique ‚Äî modifier groupes, couleurs et liaisons</h4>
      <div id="ph-ed"><p style="font-size:12px;color:#aaa">Entrez un mot ci-dessus.</p></div>
    </div>
    <div class="mf">
      <button class="bo" type="button" onclick="closeModal('m-word')">Annuler</button>
      <button class="btn" type="button" onclick="saveWord()">üíæ Enregistrer</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- MODAL: EXPORT -->
<div class="mo" id="m-export">
  <div class="mb" style="max-width:500px">
    <h3>‚¨áÔ∏è Exporter</h3>

    <div style="background:#f8f5f0;border-radius:8px;padding:14px;margin-bottom:14px;border:1px solid #e0d5c5">
      <div style="font-weight:700;font-size:14px;color:#5c4a2a;margin-bottom:6px">üíæ Sauvegarde locale</div>
      <p style="font-size:12px;color:#888;margin-bottom:10px">Toutes mes s√©ries dans un fichier .json ‚Äî pour sauvegarder ou transf√©rer sur un autre ordinateur.</p>
      <button class="btn" type="button" onclick="exportAllSeries()">‚¨áÔ∏è T√©l√©charger la sauvegarde compl√®te</button>
    </div>

    <div style="background:#f0f5ff;border-radius:8px;padding:14px;border:1px solid #c5d5e8">
      <div style="font-weight:700;font-size:14px;color:#5c4a2a;margin-bottom:6px">üì§ Partager sur GitHub</div>
      <p style="font-size:12px;color:#555;margin-bottom:4px">G√©n√®re le fichier <code style="background:#e8e0d4;padding:1px 5px;border-radius:3px">series_partagees.json</code> √† d√©poser dans votre d√©p√¥t GitHub.</p>
      <p style="font-size:12px;color:#555;margin-bottom:10px">Toutes vos coll√®gues verront vos s√©ries automatiquement √† l'ouverture du site.</p>
      <div style="background:#fff8e8;border-radius:6px;padding:8px 10px;font-size:11px;color:#8b7355;margin-bottom:10px;border:1px solid #e8d8a0">
        <strong>√âtapes :</strong><br>
        1. Cliquez sur le bouton ci-dessous<br>
        2. Le fichier <code>series_partagees.json</code> se t√©l√©charge<br>
        3. Dans GitHub, faites glisser ce fichier dans votre d√©p√¥t<br>
        4. Vos coll√®gues verront vos s√©ries d√®s le rechargement du site
      </div>
      <button class="btn" type="button" onclick="exportForGitHub()">üì§ G√©n√©rer series_partagees.json</button>
    </div>

    <div class="mf">
      <button class="bo" type="button" onclick="closeModal('m-export')">Fermer</button>
    </div>
  </div>
</div>

<!-- MODAL: IMPORT -->
<div class="mo" id="m-import">
  <div class="mb" style="max-width:560px">
    <h3>‚¨ÜÔ∏è Importer</h3>

    <!-- Section 1 : Import s√©ries JSON -->
    <div style="background:#f8f5f0;border-radius:8px;padding:14px;margin-bottom:16px;border:1px solid #e0d5c5">
      <div style="font-weight:700;font-size:14px;color:#5c4a2a;margin-bottom:8px">üì¶ Importer des s√©ries sauvegard√©es (.json)</div>
      <p style="font-size:12px;color:#888;margin-bottom:10px">Fichier export√© depuis Apprentilangue (format .json)</p>
      <label style="display:inline-block;background:#8b7355;color:#fff;padding:8px 16px;border-radius:7px;cursor:pointer;font-size:13px;font-weight:600">
        Choisir un fichier JSON
        <input type="file" id="imp-json" accept=".json" style="display:none" onchange="importJSON(this)">
      </label>
      <span id="imp-json-status" style="font-size:12px;color:#888;margin-left:10px"></span>
    </div>

    <!-- Section 2 : Import Excel -->
    <div style="background:#f8f5f0;border-radius:8px;padding:14px;border:1px solid #e0d5c5">
      <div style="font-weight:700;font-size:14px;color:#5c4a2a;margin-bottom:8px">üìä Importer une liste de mots (.xlsx)</div>
      <p style="font-size:12px;color:#888;margin-bottom:10px">Utilisez le mod√®le Excel disponible sur la page d'accueil.</p>
      <div class="fg" style="margin-bottom:10px">
        <label>Nom de la nouvelle s√©rie</label>
        <input type="text" id="imp-xl-name" placeholder="ex: LES √âMOTIONS" oninput="updatePathPreview()" style="font-weight:700;text-transform:uppercase">
      </div>
      <div class="fg" style="margin-bottom:10px">
        <label>Num√©ro du dossier images <span style="font-weight:400;color:#aaa">(ex: 05 pour images/05-√âmotions/)</span></label>
        <input type="text" id="imp-xl-dossier" placeholder="ex: 05" oninput="updatePathPreview()" style="width:80px">
        <div style="font-size:11px;color:#aaa;margin-top:3px">
          G√©n√®re automatiquement : <code id="imp-xl-path-preview" style="background:#f0ece5;padding:1px 5px;border-radius:3px">images/05-NomS√©rie/1-mot.jpg</code>
        </div>
      </div>
      <div class="fg" style="margin-bottom:10px">
        <label>Couleur de la s√©rie</label>
        <input type="color" id="imp-xl-color" value="#8b7355">
      </div>
      <div class="fg" style="margin-bottom:10px">
        <label>Police</label>
        <select id="imp-xl-font">
          <option value="MDIEcole">MDI √âcole</option>
          <option value="Calibri">Calibri</option>
          <option value="Arial">Arial</option>
          <option value="Times New Roman">Times New Roman</option>
        </select>
      </div>
      <div class="fg" style="margin-bottom:10px">
        <label>M√©thode</label>
        <div class="mt">
          <button class="mtb on" type="button" id="imp-xl-eo" onclick="setImpM('eo')">üìó Enthousiasme</button>
          <button class="mtb" type="button" id="imp-xl-bm" onclick="setImpM('bm')">üìò Borel-Maisonny</button>
        </div>
      </div>
      <label style="display:inline-block;background:#8b7355;color:#fff;padding:8px 16px;border-radius:7px;cursor:pointer;font-size:13px;font-weight:600">
        Choisir un fichier Excel
        <input type="file" id="imp-xl" accept=".xlsx,.xls" style="display:none" onchange="importExcel(this)">
      </label>
      <span id="imp-xl-status" style="font-size:12px;color:#888;margin-left:10px"></span>
    </div>

    <div class="mf">
      <button class="bo" type="button" onclick="closeModal('m-import')">Fermer</button>
    </div>
  </div>
</div>

<script>
// ================================================================
// PALETTE
// ================================================================
const PAL=[{n:'Noir',h:'#222222'},{n:'Rouge',h:'#e8002a'},{n:'Bleu clair',h:'#82c4e0'},{n:'Gris',h:'#aaaaaa'},{n:'Vert',h:'#3aaa5a'}];

// ================================================================
// DICTIONNAIRE EO
// ================================================================
const EO0={
  'a':{s:'a',i:'eo/a-avion.png',c:['#222222']},'√¢':{s:'a',i:'eo/a-avion.png',c:['#222222']},
  'b':{s:'b',i:'eo/b-bottes.png',c:['#222222']},'c':{s:'k',i:'eo/c-crocodile.png',c:['#222222']},
  '√ß':{s:'s',i:'eo/s-serpent.png',c:['#222222']},'ch':{s:'ch',i:'eo/ch-chat.png',c:['#222222','#222222']},
  'd':{s:'d',i:'eo/d-danseuse.png',c:['#222222']},'e':{s:'e',i:'eo/e-ch√®vre.png',c:['#222222']},
  '√©':{s:'√©',i:'eo/√©-√©toile.png',c:['#222222']},'√®':{s:'√®',i:'eo/√®-fl√®che.png',c:['#222222']},
  '√™':{s:'√®',i:'eo/√®-fl√®che.png',c:['#222222']},'eu':{s:'eu',i:'eo/eu-feu.png',c:['#222222','#222222']},
  'f':{s:'f',i:'eo/f-f√©e.png',c:['#222222']},'ff':{s:'f',i:'eo/f-f√©e.png',c:['#222222','#222222']},
  'g':{s:'g',i:'eo/g-gorille.png',c:['#222222']},'gn':{s:'gn',i:'eo/gn-montagne.png',c:['#222222','#222222']},
  'h':{s:'',i:'eo/Lettre_Muette.png',c:['#aaaaaa'],silent:true},'i':{s:'i',i:'eo/i-igloo.png',c:['#222222']},
  '√Æ':{s:'i',i:'eo/i-igloo.png',c:['#222222']},'j':{s:'j',i:'eo/j-jumelles.png',c:['#222222']},
  'k':{s:'k',i:'eo/c-crocodile.png',c:['#222222']},'l':{s:'l',i:'eo/l-lunettes.png',c:['#222222']},
  'll':{s:'l',i:'eo/l-lunettes.png',c:['#222222','#222222']},'m':{s:'m',i:'eo/m-moto.png',c:['#222222']},
  'mm':{s:'m',i:'eo/m-moto.png',c:['#222222','#222222']},'n':{s:'n',i:'eo/n-neige.png',c:['#222222']},
  'nn':{s:'n',i:'eo/n-neige.png',c:['#222222','#222222']},'o':{s:'o',i:'eo/o-otarie.png',c:['#222222']},
  '√¥':{s:'o',i:'eo/o-ogre.png',c:['#222222']},'p':{s:'p',i:'eo/p-pirate.png',c:['#222222']},
  'ph':{s:'f',i:'eo/f-f√©e.png',c:['#222222','#222222']},'pp':{s:'p',i:'eo/p-pirate.png',c:['#222222','#222222']},
  'qu':{s:'k',i:'eo/c-crocodile.png',c:['#222222','#aaaaaa']},'r':{s:'r',i:'eo/r-rat.png',c:['#222222']},
  'rr':{s:'r',i:'eo/r-rat.png',c:['#222222','#222222']},'s':{s:'s',i:'eo/s-serpent.png',c:['#222222']},
  'ss':{s:'s',i:'eo/s-serpent.png',c:['#222222','#222222']},'sc':{s:'s',i:'eo/s-serpent.png',c:['#222222','#222222']},
  't':{s:'t',i:'eo/t-t√©l√©phone.png',c:['#222222']},'tt':{s:'t',i:'eo/t-t√©l√©phone.png',c:['#222222','#222222']},
  'u':{s:'u',i:'eo/u-usine.png',c:['#222222']},'√ª':{s:'u',i:'eo/u-usine.png',c:['#222222']},
  'v':{s:'v',i:'eo/v-vache.png',c:['#222222']},'w':{s:'v',i:'eo/v-vache.png',c:['#222222']},
  'x':{s:'ks',i:'eo/x-taxi.png',c:['#222222']},'y':{s:'i',i:'eo/i-igloo.png',c:['#222222']},
  'z':{s:'z',i:'eo/z-z√®bre.png',c:['#222222']},
  'an':{s:'an',i:'eo/an-ange.png',c:['#222222','#222222']},'en':{s:'an',i:'eo/an-ange.png',c:['#e8002a','#222222']},
  'em':{s:'an',i:'eo/an-ange.png',c:['#e8002a','#82c4e0']},'am':{s:'an',i:'eo/an-ange.png',c:['#aaaaaa','#82c4e0']},
  'on':{s:'on',i:'eo/on-bonbon.png',c:['#222222','#222222']},'om':{s:'on',i:'eo/on-bonbon.png',c:['#222222','#222222']},
  'in':{s:'in',i:'eo/in-idien.png',c:['#222222','#222222']},
  'ain':{s:'in',i:'eo/in-idien.png',c:['#222222','#aaaaaa','#222222']},'ein':{s:'in',i:'eo/in-idien.png',c:['#222222','#aaaaaa','#222222']},
  'un':{s:'in',i:'eo/in-idien.png',c:['#222222','#222222']},
  'ou':{s:'ou',i:'eo/ou-loup.png',c:['#222222','#222222']},'oi':{s:'oi',i:'eo/oi-oie.png',c:['#222222','#222222']},
  'oin':{s:'oin',i:'eo/oin-pointe.png',c:['#222222','#222222','#222222']},
  'au':{s:'o',i:'eo/o-ogre.png',c:['#222222','#222222']},'eau':{s:'o',i:'eo/o-ogre.png',c:['#222222','#222222','#222222']},
  'ai':{s:'√®',i:'eo/√®-fl√®che.png',c:['#222222','#222222']},'ei':{s:'√®',i:'eo/√®-fl√®che.png',c:['#222222','#222222']},
  'er':{s:'√©',i:'eo/√©-√©toile.png',c:['#222222','#222222']},'ez':{s:'√©',i:'eo/√©-√©toile.png',c:['#222222','#222222']},
  'ill':{s:'il',i:'eo/il-oeil.png',c:['#222222','#222222','#222222']},'il':{s:'il',i:'eo/il-oeil.png',c:['#222222','#222222']},
  'ail':{s:'il',i:'eo/il-oeil.png',c:['#222222','#222222','#222222']},
};
// DICT BM
const BM0={
  'a':{s:'a',i:'borel/a.png',c:['#222222']},'√¢':{s:'a',i:'borel/a.png',c:['#222222']},
  'e':{s:'e',i:'borel/e.png',c:['#222222']},'√©':{s:'√©',i:'borel/e_accent_aigu.png',c:['#222222']},
  '√®':{s:'√®',i:'borel/e_accent_grave.png',c:['#222222']},'√™':{s:'√®',i:'borel/e_accent_grave.png',c:['#222222']},
  'i':{s:'i',i:'borel/i.png',c:['#222222']},'√Æ':{s:'i',i:'borel/i.png',c:['#222222']},
  'o':{s:'o',i:'borel/o.png',c:['#222222']},'√¥':{s:'o',i:'borel/o.png',c:['#222222']},
  'u':{s:'u',i:'borel/u.png',c:['#222222']},'√ª':{s:'u',i:'borel/u.png',c:['#222222']},
  'y':{s:'i',i:'borel/i.png',c:['#222222']},
  'b':{s:'b',i:'borel/b.png',c:['#222222']},'c':{s:'k',i:'borel/k.png',c:['#222222']},
  '√ß':{s:'s',i:'borel/s.png',c:['#222222']},'d':{s:'d',i:'borel/d.png',c:['#222222']},
  'f':{s:'f',i:'borel/f.png',c:['#222222']},'g':{s:'g',i:'borel/g.png',c:['#222222']},
  'h':{s:'',i:'borel/a.png',c:['#aaaaaa'],silent:true},'j':{s:'j',i:'borel/j.png',c:['#222222']},
  'k':{s:'k',i:'borel/k.png',c:['#222222']},'l':{s:'l',i:'borel/l.png',c:['#222222']},
  'm':{s:'m',i:'borel/m.png',c:['#222222']},'n':{s:'n',i:'borel/n.png',c:['#222222']},
  'p':{s:'p',i:'borel/p.png',c:['#222222']},'r':{s:'r',i:'borel/r.png',c:['#222222']},
  's':{s:'s',i:'borel/s.png',c:['#222222']},'t':{s:'t',i:'borel/t.png',c:['#222222']},
  'v':{s:'v',i:'borel/v.png',c:['#222222']},'w':{s:'v',i:'borel/v.png',c:['#222222']},
  'x':{s:'ks',i:'borel/ks.png',c:['#222222']},'z':{s:'z',i:'borel/z.png',c:['#222222']},
  'ch':{s:'ch',i:'borel/ch.png',c:['#222222','#222222']},'ph':{s:'f',i:'borel/f.png',c:['#222222','#222222']},
  'gn':{s:'gn',i:'borel/gn.png',c:['#222222','#222222']},'qu':{s:'k',i:'borel/k.png',c:['#222222','#aaaaaa']},
  'll':{s:'l',i:'borel/l.png',c:['#222222','#222222']},'ss':{s:'s',i:'borel/s.png',c:['#222222','#222222']},
  'ff':{s:'f',i:'borel/f.png',c:['#222222','#222222']},'rr':{s:'r',i:'borel/r.png',c:['#222222','#222222']},
  'mm':{s:'m',i:'borel/m.png',c:['#222222','#222222']},'nn':{s:'n',i:'borel/n.png',c:['#222222','#222222']},
  'tt':{s:'t',i:'borel/t.png',c:['#222222','#222222']},'pp':{s:'p',i:'borel/p.png',c:['#222222','#222222']},
  'an':{s:'an',i:'borel/an.png',c:['#222222','#222222']},'am':{s:'an',i:'borel/an.png',c:['#222222','#222222']},
  'en':{s:'an',i:'borel/an.png',c:['#222222','#222222']},'em':{s:'an',i:'borel/an.png',c:['#222222','#222222']},
  'in':{s:'in',i:'borel/in.png',c:['#222222','#222222']},
  'ain':{s:'in',i:'borel/in.png',c:['#222222','#222222','#222222']},'ein':{s:'in',i:'borel/in.png',c:['#222222','#222222','#222222']},
  'un':{s:'in',i:'borel/un.png',c:['#222222','#222222']},
  'on':{s:'on',i:'borel/on.png',c:['#222222','#222222']},'om':{s:'on',i:'borel/on.png',c:['#222222','#222222']},
  'ou':{s:'ou',i:'borel/ou.png',c:['#222222','#222222']},'oi':{s:'oi',i:'borel/oi.png',c:['#222222','#222222']},
  'oin':{s:'oin',i:'borel/oin.png',c:['#222222','#222222','#222222']},
  'eu':{s:'eu',i:'borel/eu.png',c:['#222222','#222222']},
  'ai':{s:'√®',i:'borel/e_accent_grave.png',c:['#222222','#222222']},'ei':{s:'√®',i:'borel/e_accent_grave.png',c:['#222222','#222222']},
  'au':{s:'o',i:'borel/o.png',c:['#222222','#222222']},'eau':{s:'o',i:'borel/o.png',c:['#222222','#222222','#222222']},
  'er':{s:'√©',i:'borel/e_accent_aigu.png',c:['#222222','#222222']},'ez':{s:'√©',i:'borel/e_accent_aigu.png',c:['#222222','#222222']},
  'ill':{s:'il',i:'borel/ill.png',c:['#222222','#222222','#222222']},'il':{s:'il',i:'borel/ill.png',c:['#222222','#222222']},
  'ail':{s:'il',i:'borel/ill.png',c:['#222222','#222222','#222222']},'eil':{s:'il',i:'borel/ill.png',c:['#222222','#222222','#222222']},
};
const PAT_EO=['eau','ain','ein','oin','ill','eil','ail','ch','ph','gn','qu','ng',
  'an','am','en','em','on','om','ou','oi','in','eu','ai','ei','au','un','er','ez','il',
  'ff','ll','mm','nn','pp','rr','ss','sc','tt','√¢','√™','√Æ','√ª','√¥','√©','√®','√ß',
  'a','b','c','d','e','f','g','h','i','j','k','l','m','n','o','p','r','s','t','u','v','w','x','y','z'];
const PAT_BM=['eau','ain','ein','oin','ill','eil','ail','ch','ph','gn','qu',
  'an','am','en','em','on','om','ou','oi','in','eu','ai','ei','au','un','er','ez','il',
  'll','ss','ff','rr','mm','nn','tt','pp','√¢','√™','√Æ','√ª','√¥','√©','√®','√ß',
  'a','b','c','d','e','f','g','h','i','j','k','l','m','n','o','p','r','s','t','u','v','w','x','y','z'];

// ================================================================
// WORD ANALYSIS
// ================================================================
// Lettres muettes en fin de mot (r√®gle contextuelle)
const SILENT_FINAL=new Set(['x','s','t','d','z','p','g','c']);
// Renvoie true si le groupe est muet en position finale dans le mot donn√©
function isSilentFinal(group,word,isLast){
  if(!isLast)return false;
  var let1=group.letters.toLowerCase();
  // Lettre seule muette en finale
  if(let1.length===1&&SILENT_FINAL.has(let1))return true;
  // Groupe "ent" verbal muet (finales verbales)
  if(let1==='ent')return true;
  return false;
}
// Image muette (m√™me chemin EO et BM)
const IMG_MUETTE='eo/Lettre_Muette.png';
const COL_MUETTE='#aaaaaa';

function markSilentFinal(groups,word){
  if(!groups.length)return groups;
  var last=groups.length-1;
  if(isSilentFinal(groups[last],word,true)){
    var g=groups[last];
    groups[last]=Object.assign({},g,{
      silent:false,
      img:IMG_MUETTE,
      lc:g.letters.split('').map(function(){return COL_MUETTE;})
    });
  }
  return groups;
}

function analyzeWord(word,method){
  const dict=method==='bm'?AD.bm:AD.eo;
  const pats=method==='bm'?PAT_BM:PAT_EO;
  const low=word.toLowerCase().normalize('NFC');
  const groups=[];let i=0;
  while(i<low.length){
    let matched=false;
    for(const pat of pats){
      if(low.startsWith(pat,i)&&dict[pat]){
        const d=dict[pat];
        groups.push({letters:word.slice(i,i+pat.length),sound:d.s,img:d.i,lc:[...d.c],silent:!!d.silent,linked:pat.length>1});
        i+=pat.length;matched=true;break;
      }
    }
    if(!matched){
      const ch=low[i],d=dict[ch];
      groups.push({letters:word[i],sound:d?d.s:ch,img:d?d.i:ch+'.png',lc:[d?d.c[0]:'#222222'],silent:false,linked:false});
      i++;
    }
  }
  // Marquer lettre muette finale
  markSilentFinal(groups,word);
  return groups;
}
function syllabify(word){
  const w=word.toLowerCase(),V='aeiouy√¢√™√Æ√¥√ª√©√®√†√π',isV=c=>V.includes(c);
  let sylls=[],cur='';
  for(let i=0;i<w.length;i++){
    cur+=w[i];
    if(isV(w[i])){
      const nx=w[i+1],nx2=w[i+2];
      if(nx&&!isV(nx)){if(nx2&&!isV(nx2)&&nx!=='l'&&nx!=='r'){cur+=nx;sylls.push(cur);cur='';i++;}else if(nx2&&isV(nx2)){sylls.push(cur);cur='';}}
    }
  }
  if(cur)sylls.push(cur);
  let pos=0,res=[];
  for(const s of sylls){res.push(word.slice(pos,pos+s.length));pos+=s.length;}
  if(pos<word.length){if(res.length)res[res.length-1]+=word.slice(pos);else res.push(word.slice(pos));}
  return res.length?res:[word];
}

// ================================================================
// APP STATE
// ================================================================
let AD={eo:JSON.parse(JSON.stringify(EO0)),bm:JSON.parse(JSON.stringify(BM0))};
let appData={series:[],settings:{colorPrimary:'#8b7355',colorPrimaryLight:'#f2ead8',colorPrimaryDark:'#5c4a2a',imagesFolder:'images/'}};
let curSeries=null,editIdx=null,curPh=[],curSylls=null,nsMethod='eo',esMethod='eo';
// S√©ries partag√©es charg√©es depuis GitHub (lecture seule)
let sharedSeries=[];
let sharedLoaded=false;

function loadData(){
  try{
    const raw=localStorage.getItem('al_v7');
    if(raw){
      const p=JSON.parse(raw);
      appData={...appData,...p};
      AD.eo={...JSON.parse(JSON.stringify(EO0)),...(p.dictEO||{})};
      AD.bm={...JSON.parse(JSON.stringify(BM0)),...(p.dictBM||{})};
      // Corriger les groupes sauvegard√©s avec silent:true sur Lettre_Muette
      // (ancienne version marquait les finales muettes avec silent:true)
      (appData.series||[]).forEach(function(s){
        (s.words||[]).forEach(function(w){
          (w.phonetics||[]).forEach(function(g){
            if(g.silent && g.img && g.img.indexOf('Lettre_Muette')>-1){
              g.silent=false;
            }
          });
        });
      });
    }
  }catch(e){}
  if(!appData.series||!appData.series.length) appData.series=[makeDemo()];
  if(!appData.series.find(s=>s.id==='demo')) appData.series.unshift(makeDemo());
}

// Charge les s√©ries partag√©es depuis series_partagees.json dans le d√©p√¥t
function loadSharedSeries(callback){
  if(sharedLoaded){if(callback)callback();return;}
  fetch('series_partagees.json?t='+Date.now())
    .then(function(r){
      if(!r.ok)throw new Error('Fichier absent');
      return r.json();
    })
    .then(function(data){
      sharedSeries=(data.series||[]).map(function(s){
        return Object.assign({},s,{_shared:true});
      });
      sharedLoaded=true;
      if(callback)callback();
    })
    .catch(function(){
      sharedSeries=[];sharedLoaded=true;
      if(callback)callback();
    });
}
function saveData(){
  const save={...appData,dictEO:AD.eo,dictBM:AD.bm};
  localStorage.setItem('al_v7',JSON.stringify(save));
  toast('Sauvegard√© ‚úì');
}
function makeDemo(){
  const mk=(w,n,def,g,nat,img)=>({word:w,theme:'LE JARDIN',num:n,total:8,definition:def,gender:g,nature:nat,image:img||'',phonetics:analyzeWord(w,'eo'),syllables:syllabify(w)});
  return{id:'demo',name:'LE JARDIN',color:'#7ab648',font:'MDIEcole',method:'eo',words:[
    mk('JARDIN',1,"C'est un terrain o√π l'on cultive des v√©g√©taux.\nC'est un nom masculin.",'masc','nom','images/jardin.png'),
    mk('BROUETTE',2,"C'est un petit v√©hicule avec une roue.\nOn s'en sert pour transporter des choses.\nC'est un nom f√©minin.",'fem','nom','images/brouette.png'),
    mk('S√âCATEUR',3,"C'est un outil pour couper des branches.\nC'est un nom masculin.",'masc','nom','images/secateur.png'),
    mk('R√ÇTEAU',4,"Outil de jardinage avec des dents.\nC'est un nom masculin.",'masc','nom','images/rateau.png'),
    mk('ARROSOIR',5,"Il sert √† arroser les plantes.\nC'est un nom masculin.",'masc','nom','images/arrosoir.png'),
    mk('GRAINE',6,"On la s√®me pour obtenir une plante.\nC'est un nom f√©minin.",'fem','nom','images/graine.png'),
    mk('SEMER',7,"C'est jeter des graines sur la terre.\nC'est un verbe.",'none','verbe','images/semer.png'),
    mk('L√âGER',8,"C'est facile √† porter.\nC'est un adjectif.",'masc','adjectif','images/leger.png'),
  ]};
}

// ================================================================
// NAV
// ================================================================
function goPage(p){
  document.querySelectorAll('.pg').forEach(e=>e.classList.remove('on'));
  document.querySelectorAll('.nb').forEach(e=>e.classList.remove('active'));
  document.getElementById('pg-'+p).classList.add('on');
  if(p==='home'){restoreAppColors();renderHome();}
  if(p==='settings') renderSettings();
}
function openModal(id){document.getElementById(id).classList.add('on');}
function closeModal(id){document.getElementById(id).classList.remove('on');}

// ================================================================
// HOME
// ================================================================
function renderHome(){
  const g=document.getElementById('series-grid');g.innerHTML='';

  // ‚îÄ‚îÄ S√©ries partag√©es (lecture seule) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(sharedSeries.length){
    const sh=document.createElement('div');
    sh.style.cssText='grid-column:1/-1;font-size:13px;font-weight:700;color:var(--cpd);'+
      'padding:4px 0 8px;border-bottom:2px solid var(--cpl);margin-bottom:4px;';
    sh.innerHTML='üìå S√©ries partag√©es';
    g.appendChild(sh);
    sharedSeries.forEach(function(s){
      g.appendChild(makeSeriesCard(s,true));
    });
    const sep=document.createElement('div');
    sep.style.cssText='grid-column:1/-1;font-size:13px;font-weight:700;color:var(--cpd);'+
      'padding:12px 0 8px;border-bottom:2px solid var(--cpl);margin-bottom:4px;margin-top:8px;';
    sep.innerHTML='üìÅ Mes s√©ries';
    g.appendChild(sep);
  }

  // ‚îÄ‚îÄ Mes s√©ries (locales) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  (appData.series||[]).forEach(function(s){
    g.appendChild(makeSeriesCard(s,false));
  });
}

function makeSeriesCard(s,isShared){
  const d=document.createElement('div');
  d.className='sc';
  d.style.borderLeftColor=s.color||'#8b7355';
  if(isShared)d.style.background='#faf8f4';

  const h3=document.createElement('h3');
  h3.textContent=s.name;
  const badge=document.createElement('span');
  badge.className='mbg '+(s.method==='bm'?'bbm':'beo');
  badge.textContent=s.method==='bm'?'üìò BM':'üìó EO';
  h3.appendChild(badge);
  if(isShared){
    const sb=document.createElement('span');
    sb.style.cssText='font-size:9px;background:#e8e0d4;color:#8b7355;border-radius:4px;padding:2px 5px;margin-left:5px;font-weight:600;';
    sb.textContent='PARTAG√âE';h3.appendChild(sb);
  }

  const p=document.createElement('p');
  p.textContent=((s.words||[]).length)+' mot(s) ¬∑ '+(s.font||'MDI √âcole');

  const btns=document.createElement('div');btns.className='scb';

  if(!isShared){
    const bEdit=document.createElement('button');
    bEdit.className='btn bsm';bEdit.type='button';bEdit.textContent='‚úèÔ∏è √âditer';
    bEdit.onclick=function(){openEditor(s.id);};
    btns.appendChild(bEdit);
  }

  const bPlay=document.createElement('button');
  bPlay.className='btn bsm bor';bPlay.type='button';bPlay.textContent='‚ñ∂ Jouer';
  bPlay.onclick=function(){
    if(isShared){startSS(s.id,s);}else{startSS(s.id);}
  };
  btns.appendChild(bPlay);

  const bExp=document.createElement('button');
  bExp.className='bo bsm';bExp.type='button';bExp.textContent='‚¨áÔ∏è';
  bExp.title=isShared?'T√©l√©charger cette s√©rie':'Exporter cette s√©rie';
  bExp.onclick=function(e){e.stopPropagation();exportSeriesObj(s);};
  btns.appendChild(bExp);

  if(isShared){
    const bDel=document.createElement('button');
    bDel.className='bd';bDel.type='button';bDel.textContent='üóë';
    bDel.title='Retirer des s√©ries partag√©es';
    bDel.onclick=function(e){e.stopPropagation();delSharedSeries(s.id);};
    btns.appendChild(bDel);
  } else {
    if(s.id==='demo'){
      const lbl=document.createElement('span');
      lbl.style.cssText='font-size:10px;color:#aaa;padding:4px 6px';
      lbl.textContent='exemple';btns.appendChild(lbl);
    }else{
      const bDel=document.createElement('button');
      bDel.className='bd';bDel.type='button';bDel.textContent='üóë';
      bDel.onclick=function(e){delSeries(s.id,e);};
      btns.appendChild(bDel);
    }
  }

  d.appendChild(h3);d.appendChild(p);d.appendChild(btns);
  return d;
}
function openNewSeriesModal(){nsMethod='eo';setNsM('eo');document.getElementById('ns-name').value='';openModal('m-newseries');}
function setNsM(m){nsMethod=m;document.getElementById('ns-eo').classList.toggle('on',m==='eo');document.getElementById('ns-bm').classList.toggle('on',m==='bm');}
function createSeries(){
  const name=document.getElementById('ns-name').value.trim();if(!name){toast('Nom requis');return;}
  const id='s'+Date.now();
  const decos=document.getElementById('ns-decos').value.split(';').map(s=>s.trim()).filter(Boolean);
  appData.series.push({id,name:name.toUpperCase(),color:document.getElementById('ns-color').value,font:document.getElementById('ns-font').value,method:nsMethod,decos,words:[]});
  saveData();closeModal('m-newseries');openEditor(id);
}
function delSeries(id,e){
  e.stopPropagation();if(!confirm('Supprimer cette s√©rie ?'))return;
  appData.series=appData.series.filter(s=>s.id!==id);saveData();renderHome();
}
function delSharedSeries(id){
  if(!confirm('Retirer cette s√©rie des s√©ries partag√©es ?\nUn fichier series_partagees.json sera t√©l√©charg√©.\nD√©posez-le sur GitHub pour que la suppression soit visible par tous.'))return;
  // Retirer la s√©rie de la liste partag√©e en m√©moire
  sharedSeries=sharedSeries.filter(function(s){return s.id!==id;});
  // G√©n√©rer et t√©l√©charger le nouveau series_partagees.json
  const data={
    version:'al_v7',
    updated:new Date().toISOString().slice(0,10),
    description:'S√©ries partag√©es Apprentilangue',
    series:sharedSeries.map(function(s){const c=Object.assign({},s);delete c._shared;return c;})
  };
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='series_partagees.json';
  a.click();URL.revokeObjectURL(a.href);
  renderHome();
  toast('series_partagees.json t√©l√©charg√© ‚Äî d√©posez-le sur GitHub ‚úì');
}

// ================================================================
// EDITOR
// ================================================================
function openEditor(id){
  curSeries=appData.series.find(s=>s.id===id);if(!curSeries)return;
  document.getElementById('editor-title').textContent='‚úèÔ∏è '+curSeries.name;
  applySeriesColors(curSeries);
  renderWords();goPage('editor');
}
function renderWords(){
  const list=document.getElementById('words-list');list.innerHTML='';
  (curSeries.words||[]).forEach((w,i)=>{
    const d=document.createElement('div');d.className='wc';
    d.innerHTML=`<div><div style="font-size:15px;font-weight:700">${w.word}</div><div style="font-size:11px;color:#999;margin-top:2px">${w.num}/${w.total} ¬∑ ${w.gender==='masc'?'M':w.gender==='fem'?'F':''} ¬∑ ${(w.nature||'').toUpperCase()}</div></div>
      <div style="display:flex;gap:5px"><button class="bo bsm" type="button" onclick="openEditWord(${i})">‚úèÔ∏è</button><button class="bd" type="button" onclick="delWord(${i})">üóë</button></div>`;
    list.appendChild(d);
  });
}
function openSeriesSettingsModal(){
  const s=curSeries;if(!s)return;
  document.getElementById('es-name').value=s.name;
  document.getElementById('es-color').value=s.color||'#7ab648';
  document.getElementById('es-font').value=s.font||'MDIEcole';
  document.getElementById('es-decos').value=(s.decos||[]).join(';');
  esMethod=s.method||'eo';setEsM(esMethod);openModal('m-series-settings');
}
function setEsM(m){esMethod=m;document.getElementById('es-eo').classList.toggle('on',m==='eo');document.getElementById('es-bm').classList.toggle('on',m==='bm');}
function saveSeriesSettings(){
  const s=curSeries;if(!s)return;
  s.name=document.getElementById('es-name').value.trim().toUpperCase()||s.name;
  s.color=document.getElementById('es-color').value;
  s.font=document.getElementById('es-font').value;
  s.method=esMethod;
  s.decos=document.getElementById('es-decos').value.split(';').map(x=>x.trim()).filter(Boolean);
  document.getElementById('editor-title').textContent='‚úèÔ∏è '+s.name;
  closeModal('m-series-settings');saveData();
}
function openAddWordModal(){
  editIdx=null;curSylls=null;curPh=[];
  document.getElementById('m-word-title').textContent='Ajouter un mot';
  document.getElementById('f-word').value='';
  document.getElementById('f-theme').value=curSeries?.name||'';
  document.getElementById('f-num').value=(curSeries?.words?.length||0)+1;
  document.getElementById('f-total').value=curSeries?.words?.[0]?.total||32;
  document.getElementById('f-def').value='';
  document.getElementById('f-gender').value='masc';
  document.getElementById('f-nature').value='nom';
  document.getElementById('f-img').value='';
  document.getElementById('ph-ed').innerHTML='<p style="font-size:12px;color:#aaa">Entrez un mot.</p>';
  document.getElementById('syll-disp').textContent='';
  openModal('m-word');
}
function openEditWord(idx){
  const w=curSeries.words[idx];
  editIdx=idx;curSylls=w.syllables?[...w.syllables]:null;
  document.getElementById('m-word-title').textContent='Modifier : '+w.word;
  document.getElementById('f-word').value=w.word;
  document.getElementById('f-theme').value=w.theme||'';
  document.getElementById('f-num').value=w.num;
  document.getElementById('f-total').value=w.total;
  document.getElementById('f-def').value=w.definition||'';
  document.getElementById('f-gender').value=w.gender||'masc';
  document.getElementById('f-nature').value=w.nature||'nom';
  document.getElementById('f-img').value=w.image||'';
  curPh=JSON.parse(JSON.stringify(w.phonetics||[]));
  updateSyllDisp();renderPhEd();openModal('m-word');
}
function delWord(idx){if(!confirm('Supprimer ?'))return;curSeries.words.splice(idx,1);saveData();renderWords();}

// ================================================================
// PHONETIC EDITOR
// ================================================================
function onWordInput(){
  const w=document.getElementById('f-word').value.trim().toUpperCase();
  if(!w){curPh=[];document.getElementById('ph-ed').innerHTML='';return;}
  curPh=analyzeWord(w,curSeries?.method||'eo');curSylls=null;
  updateSyllDisp();renderPhEd();
}
function updateSyllDisp(){
  const w=document.getElementById('f-word').value.trim().toUpperCase();
  document.getElementById('syll-disp').textContent=(curSylls||syllabify(w)).join(' ¬∑ ');
}
function renderPhEd(){
  const c=document.getElementById('ph-ed');
  if(!curPh||!curPh.length){c.innerHTML='<p style="font-size:12px;color:#aaa">Entrez un mot.</p>';return;}
  let h='<div>';
  curPh.forEach((g,gi)=>{
    const lch=g.lc.map((col,li)=>{
      const dots=PAL.map(p=>`<div class="pd${col===p.h?' sel':''}" style="background:${p.h}" title="${p.n}" onclick="setLC(${gi},${li},'${p.h}')"></div>`).join('');
      return `<div class="lcg"><div class="lcl">${g.letters[li]||''}</div><div class="pds">${dots}</div></div>`;
    }).join('');
    const cm=gi<curPh.length-1,cs=g.letters.length>1;
    h+=`<div class="phr">
      <span class="phl">${g.letters}</span>
      <input class="phs-in" style="width:62px" value="${g.sound}" onchange="updPh(${gi},'sound',this.value)" title="Son">
      <input class="phs-in" style="width:160px" value="${g.img}" onchange="updPh(${gi},'img',this.value)" title="Image">
      <label style="font-size:11px;cursor:pointer;display:flex;align-items:center;gap:3px"><input type="checkbox" ${g.silent?'checked':''} onchange="updPh(${gi},'silent',this.checked)"> muet</label>
      <label style="font-size:11px;cursor:pointer;display:flex;align-items:center;gap:3px"><input type="checkbox" ${g.linked!==false?'checked':''} onchange="updPh(${gi},'linked',this.checked)"> li√©</label>
      <div style="display:flex;gap:3px">
        ${cm?`<button class="phb" type="button" onclick="mergeG(${gi})" title="Fusionner avec le suivant">‚äï</button>`:''}
        ${cs?`<button class="phb" type="button" onclick="splitG(${gi})" title="S√©parer">‚äó</button>`:''}
      </div>
      <div class="lcs">${lch}</div>
    </div>`;
  });
  h+='</div>';c.innerHTML=h;
}
function setLC(gi,li,hex){if(curPh[gi])curPh[gi].lc[li]=hex;renderPhEd();}
function updPh(gi,f,v){
  if(!curPh[gi])return;
  curPh[gi][f]=v;
  if(f==='silent'||f==='linked'){renderPhEd();}
}
function mergeG(gi){
  const a=curPh[gi],b=curPh[gi+1];if(!b)return;
  const dict=curSeries?.method==='bm'?AD.bm:AD.eo;
  const mk=(a.letters+b.letters).toLowerCase();const info=dict[mk];
  curPh.splice(gi,2,{letters:a.letters+b.letters,sound:info?info.s:(a.sound+b.sound),img:info?info.i:a.img,lc:info?[...info.c]:[...a.lc,...b.lc],silent:a.silent&&b.silent,linked:true});
  renderPhEd();
}
function splitG(gi){
  const g=curPh[gi];if(g.letters.length<2)return;
  const dict=curSeries?.method==='bm'?AD.bm:AD.eo;
  const newG=g.letters.split('').map((letter,li)=>{const info=dict[letter.toLowerCase()];return{letters:letter,sound:info?info.s:letter.toLowerCase(),img:info?info.i:letter.toLowerCase()+'.png',lc:[g.lc[li]||'#222222'],silent:false,linked:false};});
  curPh.splice(gi,1,...newG);renderPhEd();
}
function editSylls(){
  const w=document.getElementById('f-word').value.trim().toUpperCase();
  const cur=(curSylls||syllabify(w)).join('-');
  const inp=prompt('Segmentation syllabique (tirets) :\nEx: BRO-UE-TTE',cur);
  if(inp===null)return;
  const parts=inp.trim().toUpperCase().split('-').map(p=>p.trim()).filter(Boolean);
  if(parts.join('')===w){curSylls=parts;updateSyllDisp();toast('Segmentation OK ‚úì');}
  else alert('"'+parts.join('')+'" ‚â† "'+w+'"');
}
function saveWord(){
  const w=document.getElementById('f-word').value.trim().toUpperCase();if(!w){toast('Mot vide');return;}
  const data={word:w,theme:document.getElementById('f-theme').value.trim(),num:+document.getElementById('f-num').value||1,total:+document.getElementById('f-total').value||32,definition:document.getElementById('f-def').value.trim(),gender:document.getElementById('f-gender').value,nature:document.getElementById('f-nature').value,image:document.getElementById('f-img').value.trim(),phonetics:curPh.length?curPh:analyzeWord(w,curSeries?.method||'eo'),syllables:curSylls||syllabify(w)};
  if(editIdx!==null)curSeries.words[editIdx]=data;else curSeries.words.push(data);
  curSylls=null;saveData();renderWords();closeModal('m-word');
}

// ================================================================
// SETTINGS
// ================================================================
function renderSettings(){
  const st=appData.settings||{};
  document.getElementById('col-p').value=st.colorPrimary||'#7ab648';
  document.getElementById('col-pl').value=st.colorPrimaryLight||'#d4edaa';
  document.getElementById('col-pd').value=st.colorPrimaryDark||'#5a8a30';
  document.getElementById('img-folder').value=st.imagesFolder||'images/';
  renderDictTbl('tbl-eo',AD.eo,'eo');
  renderDictTbl('tbl-bm',AD.bm,'bm');
}
function renderDictTbl(id,dict,key){
  const tbl=document.getElementById(id);
  let h='<thead><tr><th>Graph√®me</th><th>Son</th><th>Image</th><th>Couleurs</th><th></th></tr></thead><tbody>';
  Object.keys(dict).sort().forEach(k=>{
    const v=dict[k];
    const sels=v.c.map((col,li)=>`<select onchange="updDict('${key}','${k}',${li},this.value)">${PAL.map(p=>`<option value="${p.h}"${col===p.h?' selected':''}>${p.n}</option>`).join('')}</select>`).join(' ');
    h+=`<tr><td><strong>${k}</strong></td><td><input value="${v.s}" onchange="updDictF('${key}','${k}','s',this.value)" style="width:55px"></td><td><input value="${v.i}" onchange="updDictF('${key}','${k}','i',this.value)" style="width:180px"></td><td style="white-space:nowrap">${sels}</td><td><button class="bd" style="padding:2px 6px;font-size:10px" type="button" onclick="delEntry('${key}','${k}')">‚úï</button></td></tr>`;
  });
  h+='</tbody>';tbl.innerHTML=h;
}
function updDictF(key,k,f,v){const d=key==='bm'?AD.bm:AD.eo;if(d[k])d[k][f]=v;}
function updDict(key,k,li,v){const d=key==='bm'?AD.bm:AD.eo;if(d[k]&&d[k].c)d[k].c[li]=v;}
function addEntry(key){
  const g=prompt('Nouveau graph√®me (ex: th, eau) :','');if(!g||!g.trim())return;
  const k=g.trim().toLowerCase();const d=key==='bm'?AD.bm:AD.eo;
  if(d[k]){toast('Graph√®me d√©j√† existant');return;}
  const s=prompt('Son phon√©tique :',k)||k;
  const img=prompt('Fichier image :',key==='bm'?`borel/${k}.png`:`${k}.png`)||'';
  d[k]={s,i:img,c:['#222222']};
  toast('"'+k+'" ajout√© ‚úì');renderDictTbl(key==='bm'?'tbl-bm':'tbl-eo',d,key);
}
function delEntry(key,k){
  if(!confirm('Supprimer "'+k+'" ?'))return;
  const d=key==='bm'?AD.bm:AD.eo;delete d[k];
  renderDictTbl(key==='bm'?'tbl-bm':'tbl-eo',d,key);toast('"'+k+'" supprim√©');
}
function liveCol(){
  document.documentElement.style.setProperty('--cp',document.getElementById('col-p').value);
  document.documentElement.style.setProperty('--cpl',document.getElementById('col-pl').value);
  document.documentElement.style.setProperty('--cpd',document.getElementById('col-pd').value);
}
function saveSettings(){
  appData.settings={colorPrimary:document.getElementById('col-p').value,colorPrimaryLight:document.getElementById('col-pl').value,colorPrimaryDark:document.getElementById('col-pd').value,imagesFolder:document.getElementById('img-folder').value||'images/'};
  saveData();
}
function resetDicts(){if(!confirm('R√©initialiser les dictionnaires ?'))return;AD.eo=JSON.parse(JSON.stringify(EO0));AD.bm=JSON.parse(JSON.stringify(BM0));saveData();renderSettings();}

// ================================================================
// SLIDESHOW
// ================================================================
let SS={series:null,slides:[],idx:0,step:0,casse:'script'};

function startSS(id,seriesObj){
  if(seriesObj){
    curSeries=seriesObj;
  }else{
    curSeries=appData.series.find(s=>s.id===id);
  }
  if(!curSeries||!curSeries.words||!curSeries.words.length){toast('Aucun mot dans cette s√©rie');return;}
  // Ouvrir le modal de choix de casse
  openModal('m-launch');
}
function confirmLaunchSS(){
  closeModal('m-launch');
  const casse=document.querySelector('input[name="ss-casse"]:checked')?.value||'script';
  SS.casse=casse;
  launchSS();
}
function launchSS(){
  if(!curSeries||!curSeries.words||!curSeries.words.length){toast('Aucun mot');return;}
  SS.series=curSeries;
  applySeriesColors(curSeries);
  buildSS(curSeries);
  document.getElementById('ss-wrap').classList.add('on');
  ssGoto(0);
}
function buildSS(series){
  const stage=document.getElementById('ss-stage');stage.innerHTML='';
  const casse=SS.casse||'script';
  const font=casse==='script'?'MDIEcole':casse==='cursive'?'Cursive Dumont maternelle':(series.font||'MDIEcole');
  const folder=appData.settings?.imagesFolder||'images/';
  // Title
  const decos=series.decos||[];
  const shDecos=decos.length
    ?('<div class="sh-decos">'+decos.map(function(d){return '<img src="'+d+'" onerror="this.style.display=\'none\'">';}).join('')+'</div>')
    :'';
  const waveColor=series.color||'#7ab648';
  const wave=`<div class="grass"><svg viewBox="0 0 1200 20" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg"><path d="M0 20 Q50 4 100 20 Q150 4 200 20 Q250 4 300 20 Q350 4 400 20 Q450 4 500 20 Q550 4 600 20 Q650 4 700 20 Q750 4 800 20 Q850 4 900 20 Q950 4 1000 20 Q1050 4 1100 20 Q1150 4 1200 20 Z" fill="${waveColor}"/></svg></div>`;

  const tEl=mkEl('div','slide sl-title');tEl.id='ss-title';
  tEl.innerHTML=`<h1>APPRENTILANGUE</h1><h2>${series.name}</h2><div style="margin-top:auto;width:100%">${wave}</div>`;stage.appendChild(tEl);
  // Sommaire
  const sEl=mkEl('div','slide sl-som');sEl.id='ss-som';
  sEl.innerHTML=`<div class="sh" style="position:relative"><span>${series.name}</span>${shDecos}<span>SOMMAIRE</span></div>
    <div class="som-grid">${series.words.map((w,i)=>`<div class="som-item" onclick="ssGotoWord(${i})"><span class="som-num">${String(w.num).padStart(2,'0')}</span><span>${w.word}</span></div>`).join('')}</div>
    ${wave}`;
  stage.appendChild(sEl);
  // Words
  series.words.forEach((w,wi)=>{
    stage.appendChild(buildSlideA(w,wi,series.name,font,folder,wave,shDecos,casse));
    stage.appendChild(buildSlideB(w,wi,series.name,font,wave,shDecos,casse));
  });
  SS.slides=[{el:tEl,type:'title'},{el:sEl,type:'som'}];
  series.words.forEach((w,wi)=>{
    SS.slides.push({el:document.getElementById('sa-'+wi),type:'a',word:w,wi});
    SS.slides.push({el:document.getElementById('sb-'+wi),type:'b',word:w,wi});
  });
}
function mkEl(tag,cls){const e=document.createElement(tag);e.className=cls;return e;}

function buildSlideA(word,wi,seriesName,font,folder,wave,shDecos,casse){
  const ph=word.phonetics||[];
  // D√©terminer le "dernier mot" : la partie apr√®s le dernier espace ou apostrophe
  const rawWord=word.word||'';
  const splitIdx=Math.max(rawWord.lastIndexOf(' '),rawWord.lastIndexOf("'"),rawWord.lastIndexOf('‚Äô'));
  const lastWordStart=splitIdx>=0?splitIdx+1:0; // position dans le mot entier
  // Segmentation appliqu√©e uniquement sur le dernier mot
  const lastWord=rawWord.slice(lastWordStart);
  const sylls=word.syllables||syllabify(lastWord);
  const defLines=(word.definition||'').split('\n');
  const syllBounds=new Set();let pos=0;
  sylls.forEach((s,i)=>{if(i>0)syllBounds.add(pos);pos+=s.length;});
  let wordPos=0,rowH='';
  // Position dans le dernier mot uniquement (pour la segmentation)
  let lastWordPos=0;
  ph.forEach((g,gi)=>{
    const isSpace=g.letters===' ';
    const isApos=g.letters==="'"||g.letters==='‚Äô';
    const isSep=isSpace||isApos;
    // S√©parateur (espace ou apostrophe) : affichage sans trait
    if(isSep){
      if(isSpace){
        rowH+=`<div class="pg-grp"><div class="ls"><div class="lc" id="lc-${wi}-${gi}-0" style="color:transparent;font-family:'${font}',MDIEcole,Calibri,sans-serif">${g.letters}</div></div></div>`;
      } else {
        rowH+=`<div class="pg-grp"><div class="ls"><div class="lc" id="lc-${wi}-${gi}-0" style="color:#222222;font-family:'${font}',MDIEcole,Calibri,sans-serif">${g.letters}</div></div></div>`;
      }
      wordPos+=g.letters.length;
      lastWordPos=0; // reset : on repart dans le nouveau mot
      return;
    }
    // S√©parateur syllabique uniquement dans le dernier mot
    if(lastWordPos>0&&syllBounds.has(lastWordPos))rowH+=`<div class="ssep"></div>`;
    rowH+=`<div class="pg-grp">`;
    g.letters.split('').forEach((letter,li)=>{
      const col=(g.lc&&g.lc[li])||'#222222';
      const notLast=li<g.letters.length-1;
      const dispLetter=casse==='upper'?letter.toUpperCase():letter.toLowerCase();
      rowH+=`<div class="ls"><div class="lc" id="lc-${wi}-${gi}-${li}" style="color:${col};font-family:'${font}',MDIEcole,Calibri,sans-serif">${dispLetter}</div><div class="lb" style="background:${col}"></div></div>`;
      if(notLast&&g.linked!==false)rowH+=`<div class="dw" style="margin-bottom:2px"><div class="ld" style="background:#222222"></div></div>`;
    });
    rowH+=`<img class="si" id="si-${wi}-${gi}" src="${folder}${g.img}" alt="${g.sound}" onerror="this.style.visibility='hidden'">`;
    rowH+=`</div>`;
    wordPos+=g.letters.length;
    lastWordPos+=g.letters.length;
  });
  const el=mkEl('div','slide');el.id='sa-'+wi;
  el.innerHTML=`<div class="sh" style="position:relative"><span>${word.theme||seriesName}</span>${shDecos||''}<span>${word.num}/${word.total}</span></div>
    <div class="sab">
      <div class="def-box">${defLines.map((l,i)=>`<div class="def-line" id="dl-${wi}-${i}">${l||'&nbsp;'}</div>`).join('')}</div>
      ${word.image?`<img class="wi" id="wi-${wi}" src="${word.image}" alt="${word.word}" onerror="this.style.display='none'">`:`<div style="position:absolute;top:4px;right:10px;width:160px;height:140px;border:2px dashed #ccc;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:10px;color:#bbb;z-index:2">image</div>`}
      <div class="wz"><div class="lr" style="margin-bottom:80px">${rowH}</div></div>
    </div>${wave||''}`;
  return el;
}
function buildSlideB(word,wi,seriesName,font,wave,shDecos,casse){
  const el=mkEl('div','slide');el.id='sb-'+wi;
  el.innerHTML=`<div class="sh" style="position:relative"><span>${word.theme||seriesName}</span>${shDecos||''}<span>${word.num}/${word.total}</span></div>
    <div class="sbb">
      <div class="wa">
        <div class="wcv">${word.word.toLowerCase()}</div>
        <div class="wr">
          <div class="wca" style="font-family:'${font}',MDIEcole,Calibri,sans-serif">${casse==='upper'?word.word.toUpperCase():word.word.toLowerCase()}</div>
          <div class="wsc" style="font-family:'${font}',MDIEcole,Calibri,sans-serif">${word.word.toLowerCase()}</div>
        </div>
        ${word.image?`<img class="wib" src="${word.image}" alt="${word.word}" onerror="this.style.display='none'">` :''}
      </div>
      <div class="gb">
        <div class="sb-cat-label">GENRE</div>
        <div class="ci2"><div class="cb" id="cbm-${wi}"></div><span style="color:#5a8a6a">MASCULIN</span></div>
        <div class="ci2"><div class="cb" id="cbf-${wi}"></div><span style="color:#c2724f">F√âMININ</span></div>
      </div>
      <div class="nb2">
        <div class="sb-cat-label">NATURE</div>
        <div class="ci2"><div class="cb" id="cbn-${wi}"></div><span style="color:#4a90d9">NOM</span></div>
        <div class="ci2"><div class="cb" id="cbv-${wi}"></div><span style="color:#e85d9a">VERBE</span></div>
        <div class="ci2"><div class="cb" id="cba-${wi}"></div><span style="color:#3aaa5a">ADJECTIF</span></div>
        <div class="ci2"><div class="cb" id="cbo-${wi}"></div><span style="color:#888">AUTRE</span></div>
      </div>
    </div>${wave||''}`;
  return el;
}

// SS CONTROL
function ssGoto(idx){
  document.querySelectorAll('#ss-stage .slide').forEach(e=>e.classList.remove('on'));
  SS.idx=Math.max(0,Math.min(idx,SS.slides.length-1));SS.step=0;
  const s=SS.slides[SS.idx];if(!s)return;
  s.el.classList.add('on');
  if(s.type==='a'){
    s.el.querySelectorAll('.lc').forEach(e=>e.classList.remove('on'));
    s.el.querySelectorAll('.si').forEach(e=>e.classList.remove('on'));
    s.el.querySelectorAll('.def-line').forEach(e=>e.classList.remove('on'));
    const img=document.getElementById('wi-'+s.wi);if(img)img.classList.remove('on');
    document.getElementById('ss-hint').textContent='‚Üí def ‚Üí image ‚Üí üîäson ‚Üí lettre';
  }else if(s.type==='b'){
    const wi=s.wi;
    ['cbm','cbf','cbn','cbv','cba','cbo'].forEach(id=>{const el=document.getElementById(id+'-'+wi);if(el){el.classList.remove('ok','ko');el.innerHTML=''}});
    document.getElementById('ss-hint').textContent='‚Üí genre ‚Üí nature ‚Üí suivant';
  }else{document.getElementById('ss-hint').textContent='';}
}
function ssClick(){
  const s=SS.slides[SS.idx];if(!s)return;
  if(s.type==='title'){ssGoto(1);return;}
  if(s.type==='som')return;
  if(s.type==='a')ssAdvA(s);
  if(s.type==='b')ssAdvB(s);
}
function ssAdvA(s){
  const wi=s.wi,word=s.word,ph=word.phonetics||[];
  const defs=(word.definition||'').split('\n').filter(l=>l.trim());
  const total=ph.reduce((sum,p)=>sum+(p.silent?1:2),0);
  // Tout est d√©j√† affich√© ‚Üí clic passe √† la slide B
  if(SS.step>=2+total){ssNext();return;}
  if(SS.step===0){defs.forEach((_,i)=>{const el=document.getElementById('dl-'+wi+'-'+i);if(el)el.classList.add('on');});SS.step=1;}
  else if(SS.step===1){const img=document.getElementById('wi-'+wi);if(img)img.classList.add('on');SS.step=2;}
  else{
    let rem=SS.step-2;
    for(let g=0;g<ph.length;g++){
      const steps=ph[g].silent?1:2;
      if(rem<steps){
        if(!ph[g].silent&&rem===0){const imgEl=document.getElementById('si-'+wi+'-'+g);if(imgEl)imgEl.classList.add('on');}
        else{ph[g].letters.split('').forEach((_,li)=>{const el=document.getElementById('lc-'+wi+'-'+g+'-'+li);if(el)el.classList.add('on');});}
        SS.step++;
        return;
      }
      rem-=steps;
    }
    // Sorti de la boucle sans rien afficher ‚Üí tout est affich√© ‚Üí slide B
    ssNext();
  }
}
function ssAdvB(s){
  const wi=s.wi,word=s.word,isLast=wi===SS.series.words.length-1;
  if(SS.step===0){
    const gender=word.gender||'masc';
    if(gender==='none'||gender==='both'){
      // Ni masculin ni f√©minin : deux ‚úó rouges
      ['cbm','cbf'].forEach(function(id){
        const el=document.getElementById(id+'-'+wi);
        if(el){el.classList.add('ko');el.innerHTML='‚úó';}
      });
    } else {
      const g=gender==='masc'?'cbm':'cbf';
      const el=document.getElementById(g+'-'+wi);
      if(el){el.classList.add('ok');el.innerHTML='‚úì';}
    }
    SS.step=1;
  }
  else if(SS.step===1){const map={nom:'cbn',verbe:'cbv',adjectif:'cba',autre:'cbo'};const el=document.getElementById((map[word.nature||'nom'])+'-'+wi);if(el){el.classList.add('ok');el.innerHTML='‚úì';}SS.step=2;}
  else{if(isLast)ssGoto(1);else ssNextWord();}
}
function ssGotoWord(wi){ssGoto(2+wi*2);}
function ssNext(){ssGoto(SS.idx+1);}
function ssBack(){ssGoto(SS.idx-1);}
function ssBack2(){ssGoto(SS.idx-2);}
function ssNextWord(){const s=SS.slides[SS.idx];if(s&&(s.type==='a'||s.type==='b')){const nx=2+(s.wi+1)*2;ssGoto(nx<SS.slides.length?nx:1);}else ssNext();}
function ssMenu(){
  document.getElementById('ss-wrap').classList.remove('on');
  restoreAppColors();
  if(curSeries){
    document.querySelectorAll('.pg').forEach(p=>p.classList.remove('on'));
    document.getElementById('pg-editor').classList.add('on');
    renderWords();
  }else{goPage('home');}
}
// SS keyboard
document.addEventListener('keydown',function(e){
  if(!document.getElementById('ss-wrap').classList.contains('on'))return;
  if(e.key==='ArrowRight'||e.key===' '){e.preventDefault();ssClick();}
  if(e.key==='ArrowLeft'){e.preventDefault();ssBack();}
  if(e.key==='Escape')ssMenu();
});
// SS click on stage
document.getElementById('ss-stage').addEventListener('click',ssClick);

// TOAST
function openGuide(){openModal('m-guide');}
function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2200);}


// ================================================================
// COLOR UTILS ‚Äî derive light/dark from series base color
// ================================================================
function hexToHSL(hex){
  let r=parseInt(hex.slice(1,3),16)/255,g=parseInt(hex.slice(3,5),16)/255,b=parseInt(hex.slice(5,7),16)/255;
  const max=Math.max(r,g,b),min=Math.min(r,g,b);let h,s,l=(max+min)/2;
  if(max===min){h=s=0;}else{
    const d=max-min;s=l>0.5?d/(2-max-min):d/(max+min);
    switch(max){case r:h=((g-b)/d+(g<b?6:0))/6;break;case g:h=((b-r)/d+2)/6;break;case b:h=((r-g)/d+4)/6;break;}
  }
  return[Math.round(h*360),Math.round(s*100),Math.round(l*100)];
}
function hslToHex(h,s,l){
  s/=100;l/=100;
  const a=s*Math.min(l,1-l);
  const f=n=>{const k=(n+h/30)%12;const color=l-a*Math.max(Math.min(k-3,9-k,1),-1);return Math.round(255*color).toString(16).padStart(2,'0');};
  return '#'+f(0)+f(8)+f(4);
}
function deriveColors(hex){
  const [h,s,l]=hexToHSL(hex);
  const cp=hex;
  const cpd=hslToHex(h,Math.min(s+10,100),Math.max(l-18,8));    // darker + saturated
  const cpl=hslToHex(h,Math.min(s+5,80),Math.min(l+38,93));     // lighter, keeps hue
  return{cp,cpd,cpl};
}
function applyColors(cp,cpd,cpl){
  document.documentElement.style.setProperty('--cp',cp);
  document.documentElement.style.setProperty('--cpd',cpd);
  document.documentElement.style.setProperty('--cpl',cpl);
}
function applySeriesColors(series){
  if(series&&series.color){
    const {cp,cpd,cpl}=deriveColors(series.color);
    applyColors(cp,cpd,cpl);
  }
}
function restoreAppColors(){
  const st=appData.settings||{};
  applyColors(st.colorPrimary||'#8b7355',st.colorPrimaryDark||'#5c4a2a',st.colorPrimaryLight||'#f2ead8');
}
// ================================================================
// EXPORT / IMPORT
// ================================================================
let impXlMethod='eo';
function setImpM(m){impXlMethod=m;document.getElementById('imp-xl-eo').classList.toggle('on',m==='eo');document.getElementById('imp-xl-bm').classList.toggle('on',m==='bm');}
function openImportModal(){openModal('m-import');updatePathPreview();}

// G√©n√®re le chemin image selon la convention : images/05-NomS√©rie/1-mot.jpg
function buildImgPath(num, mot, sName){
  var dos=document.getElementById('imp-xl-dossier');
  var dosVal=dos?dos.value.trim():'';
  if(!dosVal)return ''; // pas de dossier renseign√© ‚Üí chemin vide
  // Nettoyer le nom de s√©rie pour le dossier : "LES √âMOTIONS" ‚Üí "√âmotions"
  // On prend le dernier mot (apr√®s LES / LA / LE / L')
  var parts=sName.trim().split(/\s+/);
  var folderName=parts[parts.length-1]; // ex: √âMOTIONS
  // Capitaliser : √âMOTIONS ‚Üí √âmotions
  folderName=folderName.charAt(0).toUpperCase()+folderName.slice(1).toLowerCase();
  // Accents conserv√©s, espaces remplac√©s par -
  folderName=folderName.replace(/\s+/g,'-');
  // Nom de fichier : num√©ro + tiret + mot en minuscules sans accents pour la recherche
  // mais on garde les accents car vos fichiers les ont (ex: 1-amoureux.jpg)
  var motLow=mot.toLowerCase();
  return 'images/'+dosVal+'-'+folderName+'/'+num+'-'+motLow+'.jpg';
}

// Aper√ßu live dans le modal
function updatePathPreview(){
  var prev=document.getElementById('imp-xl-path-preview');
  if(!prev)return;
  var name=(document.getElementById('imp-xl-name')||{}).value||'LES √âMOTIONS';
  var dos=(document.getElementById('imp-xl-dossier')||{}).value||'05';
  if(!dos){prev.textContent='(entrez un num√©ro de dossier)';return;}
  // Simuler buildImgPath avec valeurs fictives
  var parts=name.trim().toUpperCase().split(/\s+/);
  var fn=parts[parts.length-1]||'S√©rie';
  fn=fn.charAt(0).toUpperCase()+fn.slice(1).toLowerCase();
  prev.textContent='images/'+dos+'-'+fn+'/1-mot.jpg';
}
function openExportModal(){openModal('m-export');}

// ‚îÄ‚îÄ EXPORT ALL SERIES ‚Üí JSON (sauvegarde locale) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function exportAllSeries(){
  const data={version:'al_v7',exported:new Date().toISOString(),series:appData.series,dictEO:AD.eo,dictBM:AD.bm};
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='apprentilangue_sauvegarde_'+new Date().toISOString().slice(0,10)+'.json';
  a.click();URL.revokeObjectURL(a.href);
  toast('Sauvegarde t√©l√©charg√©e ‚úì');
}

// ‚îÄ‚îÄ EXPORT POUR GITHUB (g√©n√®re series_partagees.json) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function exportForGitHub(){
  // Exporte toutes mes s√©ries (sauf d√©mo) au format √† d√©poser sur GitHub
  const series=appData.series.filter(function(s){return s.id!=='demo';});
  if(!series.length){toast('Aucune s√©rie √† partager');return;}
  const data={
    version:'al_v7',
    updated:new Date().toISOString(),
    description:'S√©ries partag√©es Apprentilangue ‚Äî d√©poser ce fichier dans le d√©p√¥t GitHub',
    series:series
  };
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='series_partagees.json';
  a.click();URL.revokeObjectURL(a.href);
  toast('Fichier GitHub pr√™t ‚Äî d√©posez series_partagees.json dans votre d√©p√¥t ‚úì');
}

// ‚îÄ‚îÄ EXPORT ONE SERIES ‚Üí JSON ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function exportSeries(id){
  const s=appData.series.find(x=>x.id===id);if(!s)return;
  exportSeriesObj(s);
}
function exportSeriesObj(s){
  const data={version:'al_v7',exported:new Date().toISOString(),series:[s]};
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='serie_'+s.name.toLowerCase().replace(/[\s']/g,'_')+'.json';
  a.click();URL.revokeObjectURL(a.href);
  toast('S√©rie export√©e ‚úì');
}

// ‚îÄ‚îÄ IMPORT JSON ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function importJSON(input){
  const file=input.files[0];if(!file)return;
  const st=document.getElementById('imp-json-status');
  st.textContent='Lecture...';
  const reader=new FileReader();
  reader.onload=function(e){
    try{
      const data=JSON.parse(e.target.result);
      const series=data.series||[];
      if(!series.length){st.textContent='‚ùå Aucune s√©rie trouv√©e';return;}
      let added=0,updated=0;
      series.forEach(function(s){
        if(s.id==='demo')return; // ne pas √©craser la d√©mo
        const existing=appData.series.findIndex(x=>x.id===s.id);
        if(existing>-1){appData.series[existing]=s;updated++;}
        else{appData.series.push(s);added++;}
      });
      // Merge dicts if present
      if(data.dictEO)AD.eo=Object.assign(JSON.parse(JSON.stringify(EO0)),data.dictEO);
      if(data.dictBM)AD.bm=Object.assign(JSON.parse(JSON.stringify(BM0)),data.dictBM);
      saveData();renderHome();
      st.textContent='‚úÖ '+added+' ajout√©e(s), '+updated+' mise(s) √† jour';
      input.value='';
    }catch(err){st.textContent='‚ùå Fichier invalide: '+err.message;}
  };
  reader.readAsText(file);
}

// ‚îÄ‚îÄ IMPORT EXCEL ‚Üí NOUVELLE S√âRIE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function importExcel(input){
  const file=input.files[0];if(!file)return;
  const st=document.getElementById('imp-xl-status');
  const sName=document.getElementById('imp-xl-name').value.trim().toUpperCase();
  if(!sName){st.textContent='‚ùå Entrez un nom de s√©rie';input.value='';return;}
  st.textContent='Lecture...';
  const reader=new FileReader();
  reader.onload=function(e){
    try{
      if(typeof XLSX==='undefined'){st.textContent='‚ùå SheetJS non charg√© (v√©rifiez votre connexion)';return;}
      const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'});
      const ws=wb.Sheets[wb.SheetNames[0]];
      const rows=XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
      // Find first data row (skip title/header/instruction/example rows)
      // Data rows: col A is a number, col B is non-empty text
      const words=[];
      for(let ri=0;ri<rows.length;ri++){
        const row=rows[ri];
        const num=parseInt(row[0]);
        const mot=String(row[1]||'').trim().toUpperCase();
        if(isNaN(num)||num<1||!mot)continue;
        const theme=String(row[2]||sName).trim().toUpperCase()||sName;
        const def=String(row[3]||'').trim().replace(/\\n/g,'\n');
        const gender=String(row[4]||'masc').trim().toLowerCase()||'masc';
        const nature=String(row[5]||'nom').trim().toLowerCase()||'nom';
        const segRaw=String(row[6]||'').trim();
        const lienRaw=String(row[7]||'').trim();
        const colRaw=String(row[8]||'').trim();
        const imgRaw=String(row[9]||'').trim();
        const total=parseInt(row[10])||32;
        // G√©n√©rer chemin auto si colonne vide : images/05-NomS√©rie/1-mot.jpg
        const img=imgRaw||buildImgPath(num,mot,sName);
        // Parse phonetics from segmentation + liaisons + couleurs
        const ph=parsePhonetics(mot,segRaw,lienRaw,colRaw,impXlMethod);
        // Parse syllables from segmentation (use | as syllable sep if no phonetic grouping)
        const sylls=parseSylls(mot,segRaw);
        words.push({word:mot,theme,num,total,definition:def,gender,nature,image:img,phonetics:ph,syllables:sylls});
      }
      if(!words.length){st.textContent='‚ùå Aucun mot trouv√© (v√©rifiez le format)';input.value='';return;}
      // Create series
      const id='s'+Date.now();
      const newSeries={
        id,name:sName,
        color:document.getElementById('imp-xl-color').value,
        font:document.getElementById('imp-xl-font').value,
        method:impXlMethod,decos:[],words
      };
      appData.series.push(newSeries);
      saveData();renderHome();closeModal('m-import');
      curSeries=newSeries;openEditor(id);
      st.textContent='‚úÖ '+words.length+' mot(s) import√©(s)';
      input.value='';
    }catch(err){st.textContent='‚ùå Erreur: '+err.message;console.error(err);}
  };
  reader.readAsArrayBuffer(file);
}

// ‚îÄ‚îÄ PALETTE NOMS ‚Üí HEX ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var COLOR_NAMES={
  'noir':'#222222','black':'#222222',
  'rouge':'#e8002a','red':'#e8002a',
  'bleu clair':'#82c4e0','bleu':'#82c4e0','blue':'#82c4e0','cyan':'#82c4e0',
  'gris':'#aaaaaa','grey':'#aaaaaa','gray':'#aaaaaa',
  'vert':'#3aaa5a','green':'#3aaa5a'
};
function resolveColor(s){
  s=(s||'').trim().toLowerCase();
  if(!s)return'#222222';
  if(COLOR_NAMES[s])return COLOR_NAMES[s];
  // accept hex with or without #
  if(/^#?[0-9a-f]{3,6}$/i.test(s))return s.startsWith('#')?s:'#'+s;
  return'#222222';
}

// ‚îÄ‚îÄ PARSE SYLLABES (colonne Segmentation) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Sert uniquement √† l'affichage visuel des syllabes (s√©paration par tiret).
// N'affecte PAS les groupes phon√©tiques (d√©duits automatiquement).
function parseSyllsFromRaw(mot,segRaw){
  if(!segRaw||!segRaw.trim())return syllabify(mot);
  var sep=segRaw.indexOf('|')>-1?'|':'-';
  var parts=segRaw.split(sep).map(function(g){return g.trim();}).filter(Boolean);
  // V√©rifier que √ßa reconstruit bien le mot
  if(parts.join('').toUpperCase()===mot.toUpperCase())return parts;
  return syllabify(mot);
}

// ‚îÄ‚îÄ PARSE LIAISONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Format : "ou;eu"  ‚Üí les GROUPES PHON√âTIQUES nomm√©s seront li√©s.
// Les groupes phon√©tiques sont ceux produits par analyzeWord (ex: ou, eu, on‚Ä¶).
// Quand lienRaw est vide : comportement par d√©faut du dictionnaire.
// Quand lienRaw est fourni : SEULS les groupes list√©s sont li√©s.
// "on;on" lie la 1√®re ET la 2√®me occurrence du groupe ON.
function applyLiens(phonGroups, lienRaw){
  if(!lienRaw||!lienRaw.trim()){
    // D√©faut : li√© si le groupe a >1 lettre ET est dans le dictionnaire comme digraphe
    return phonGroups.map(function(g){return g.linked;});
  }
  // Construire la liste des demandes avec comptage d'occurrences
  var demandes=lienRaw.split(';').map(function(x){return x.trim().toUpperCase();}).filter(Boolean);
  var demOcc={};
  demandes.forEach(function(d){
    if(!demOcc[d])demOcc[d]=0;
    demOcc[d]++;
  });
  // Convertir en liste d'occurrences √† lier : {OU:[0], ON:[0,1], EU:[0]}
  var demTarget={};
  demandes.forEach(function(d){
    if(!demTarget[d])demTarget[d]=[];
    demTarget[d].push(demTarget[d].length);
  });
  // Parcourir les groupes phon√©tiques r√©els et cocher ceux demand√©s
  var occFound={};
  return phonGroups.map(function(g){
    var key=g.letters.toUpperCase();
    if(!occFound[key])occFound[key]=0;
    var occ=occFound[key];
    occFound[key]++;
    if(demTarget[key]&&demTarget[key].indexOf(occ)>-1)return true;
    return false;
  });
}

// ‚îÄ‚îÄ PARSE COULEURS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Format : "u=bleu clair;m=bleu clair"
// Toutes les lettres sont noires par d√©faut.
// On pr√©cise seulement celles qui changent : lettre=couleur s√©par√©s par ;
// G√®re les groupes phon√©tiques : "ou=rouge" colorie les 2 lettres du groupe OU.
// G√®re les occurrences : "a=rouge;a=bleu" ‚Üí 1er A rouge, 2e A bleu.
function applyCouleurs(mot, phonGroups, colRaw){
  // Tableau plat de couleurs : une couleur par position de lettre dans le mot
  var allLetters=mot.toUpperCase();
  var flatColors=allLetters.split('').map(function(){return'#222222';});

  if(colRaw&&colRaw.trim()){
    var items=colRaw.split(';').map(function(x){return x.trim();}).filter(Boolean);
    // Construire map : "U:0"->hex, "M:0"->hex, "OU:0"->hex ...
    var colorMap={};
    var occDemand={};
    items.forEach(function(item){
      var eq=item.indexOf('=');
      if(eq<0)return;
      var letPart=item.slice(0,eq).trim().toUpperCase();
      var colPart=item.slice(eq+1).trim();
      var hex=resolveColor(colPart);
      if(!occDemand[letPart])occDemand[letPart]=0;
      colorMap[letPart+':'+occDemand[letPart]]=hex;
      occDemand[letPart]++;
    });
    // Appliquer au niveau des GROUPES PHON√âTIQUES (pour g√©rer "ou=rouge" ‚Üí 2 lettres)
    var occGroup={};
    var pos=0;
    phonGroups.forEach(function(g){
      var key=g.letters.toUpperCase();
      if(!occGroup[key])occGroup[key]=0;
      var occ=occGroup[key];
      var groupHex=colorMap[key+':'+occ]||null;
      for(var li=0;li<g.letters.length;li++){
        if(groupHex){
          flatColors[pos]=groupHex; // couleur du groupe entier
        } else {
          // Chercher couleur lettre individuelle
          var ch=g.letters[li].toUpperCase();
          if(!occGroup[ch])occGroup[ch]=0;
          var chOcc=occGroup[ch];
          var chHex=colorMap[ch+':'+chOcc]||null;
          if(chHex)flatColors[pos]=chHex;
          occGroup[ch]++;
        }
        pos++;
      }
      occGroup[key]++;
    });
  }

  // R√©partir les couleurs par groupe phon√©tique
  var pos2=0;
  return phonGroups.map(function(g){
    var lc=[];
    for(var i=0;i<g.letters.length;i++){lc.push(flatColors[pos2]||'#222222');pos2++;}
    return lc;
  });
}

// ‚îÄ‚îÄ PARSE PHONETICS FROM EXCEL COLUMNS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Strat√©gie en deux √©tapes :
//   1. Segmentation ‚Üí d√©coupe le mot en syllabes (ex: "a-mou-reux" ‚Üí [a][mou][reux])
//   2. analyzeWord appliqu√© √† CHAQUE syllabe s√©par√©ment
//      ‚Üí "a"   donne [A]
//      ‚Üí "mou" donne [M][OU]   (OU est li√© car digraphe du dict)
//      ‚Üí "reux" donne [R][EU][X]  (EU est li√©)
//   3. Liaisons ‚Üí √©craser linked sur les groupes phon√©tiques r√©sultants
//   4. Couleurs ‚Üí √©craser lc sur les groupes phon√©tiques r√©sultants
function parsePhonetics(mot,segRaw,lienRaw,colRaw,method){
  var phonGroups;

  if(segRaw&&segRaw.trim()){
    // √âtape 1 : d√©couper en syllabes selon la segmentation
    var sep=segRaw.indexOf('|')>-1?'|':'-';
    var sylls=segRaw.split(sep).map(function(g){return g.trim();}).filter(Boolean);
    // V√©rifier coh√©rence avec le mot
    if(sylls.join('').toUpperCase()!==mot.toUpperCase()){
      // Segmentation incoh√©rente ‚Üí fallback auto
      phonGroups=analyzeWord(mot,method);
    } else {
      // √âtape 2 : analyzeWord sur chaque syllabe ‚Üí aplatir les r√©sultats
      phonGroups=[];
      sylls.forEach(function(syll){
        var subGroups=analyzeWord(syll,method);
        subGroups.forEach(function(g){phonGroups.push(g);});
      });
      // Re-marquer la finale sur le MOT ENTIER (pas seulement la derni√®re syllabe)
      // car analyzeWord ne conna√Æt pas la position dans le mot global
      markSilentFinal(phonGroups,mot);
    }
  } else {
    // Pas de segmentation ‚Üí d√©coupage auto sur le mot entier
    phonGroups=analyzeWord(mot,method);
  }

  // √âtape 3 : appliquer les liaisons demand√©es
  if(lienRaw&&lienRaw.trim()){
    var linked=applyLiens(phonGroups,lienRaw);
    phonGroups=phonGroups.map(function(g,i){
      return Object.assign({},g,{linked:linked[i]});
    });
  }

  // √âtape 4 : appliquer les couleurs demand√©es
  if(colRaw&&colRaw.trim()){
    var groupColors=applyCouleurs(mot,phonGroups,colRaw);
    phonGroups=phonGroups.map(function(g,i){
      return Object.assign({},g,{lc:groupColors[i]});
    });
  }

  return phonGroups;
}

// ‚îÄ‚îÄ PARSE SYLLABLES FROM SEGMENTATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function parseSylls(mot,segRaw){
  return parseSyllsFromRaw(mot,segRaw);
}

// ================================================================
// AUTO-RELOAD ‚Äî d√©tection de nouvelle version sur GitHub
// ================================================================
// Principe : √† chaque d√©ploiement, le fichier version.json contient
// un timestamp. Le site compare avec la version mise en cache.
// Si diff√©rente ‚Üí rechargement forc√© (bypass cache navigateur).
function checkForUpdate(){
  // Ne pas tourner en local (file://) pour ne pas boucler inutilement
  if(window.location.protocol==='file:')return;
  fetch('version.json?t='+Date.now())
    .then(function(r){return r.ok?r.json():null;})
    .then(function(data){
      if(!data||!data.v)return;
      var stored=sessionStorage.getItem('al_version');
      if(!stored){
        // Premi√®re visite de la session : m√©moriser et continuer
        sessionStorage.setItem('al_version',data.v);
      } else if(stored!==data.v){
        // Nouvelle version d√©tect√©e ‚Üí recharger avec cache-bust
        sessionStorage.setItem('al_version',data.v);
        window.location.href=window.location.pathname+'?v='+data.v;
      }
      // V√©rifier de nouveau toutes les 5 minutes (pour les onglets ouverts longtemps)
      setTimeout(checkForUpdate, 5*60*1000);
    })
    .catch(function(){
      // version.json absent ou r√©seau indispo ‚Üí on ne fait rien
    });
}

// ================================================================
// INIT
// ================================================================
loadData();
restoreAppColors();
// V√©rifier les mises √† jour en premier
checkForUpdate();
// Charger les s√©ries partag√©es depuis GitHub, puis afficher
loadSharedSeries(function(){renderHome();});
</script>

<!-- MODAL: GUIDE UTILISATEUR -->
<div class="mo" id="m-guide" style="align-items:flex-start;padding:20px 0">
  <div class="mb" style="max-width:720px;width:95%;max-height:90vh;overflow-y:auto;padding:28px 32px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;position:sticky;top:-28px;background:#fff;padding:10px 0;z-index:2;border-bottom:1px solid #eee">
      <h2 style="margin:0;font-size:20px;color:var(--cpd)">üìñ Guide utilisateur</h2>
      <button class="bo" type="button" onclick="closeModal('m-guide')" style="font-size:18px;padding:4px 12px">‚úï</button>
    </div>
    <div class="guide-content">

      <div class="guide-tip">Ce guide est destin√© aux enseignantes qui utilisent Apprentilangue. Pas besoin de connaissances informatiques particuli√®res !</div>

      <h3>Qu'est-ce qu'Apprentilangue ?</h3>
      <p>Un outil pour cr√©er des <strong>diaporamas interactifs</strong> pour travailler le vocabulaire avec vos √©l√®ves. Pour chaque mot, l'application affiche la d√©finition, l'image du mot, les sons lettre par lettre, le genre et la nature. Tout se passe dans votre navigateur ‚Äî rien √† installer.</p>

      <h3>1. Lancer un diaporama</h3>
      <ol>
        <li>Rep√©rez la s√©rie sur l'√©cran d'accueil</li>
        <li>Cliquez sur <strong>‚ñ∂ Jouer</strong></li>
        <li>Choisissez l'affichage des lettres : <strong>Scriptes</strong> (habituel), <strong>Capitales</strong>, ou <strong>Cursive</strong></li>
        <li>Cliquez sur <strong>‚ñ∂ Lancer</strong></li>
      </ol>

      <h3>2. Naviguer dans le diaporama</h3>
      <table class="guide-table">
        <tr><th>Action</th><th>Comment faire</th></tr>
        <tr><td>Avancer</td><td>Clic sur la diapositive ‚Äî ou touche <kbd>‚Üí</kbd> ou <kbd>Espace</kbd></td></tr>
        <tr><td>Reculer</td><td>Touche <kbd>‚Üê</kbd></td></tr>
        <tr><td>Quitter</td><td>Touche <kbd>√âchap</kbd></td></tr>
      </table>
      <p><strong>Diapositive 1</strong> ‚Äî chaque clic r√©v√®le : d√©finition ‚Üí image ‚Üí image du son ‚Üí lettre. Le dernier clic passe √† la diapositive 2.</p>
      <p><strong>Diapositive 2</strong> ‚Äî genre (MASCULIN / F√âMININ), nature (NOM / VERBE‚Ä¶), √©criture cursive et scripte.</p>
      <p><strong>Sommaire</strong> ‚Äî cliquez directement sur un mot pour y acc√©der.</p>

      <h3>3. Cr√©er une nouvelle s√©rie</h3>
      <ol>
        <li>Cliquez sur <strong>+ Nouvelle s√©rie</strong></li>
        <li>Remplissez le nom, la couleur, la police et la m√©thode (EO ou BM)</li>
        <li>Cliquez sur <strong>Cr√©er</strong></li>
      </ol>

      <h3>4. Ajouter des mots √† la main</h3>
      <ol>
        <li>Dans l'√©diteur de s√©rie, cliquez sur <strong>+ Ajouter un mot</strong></li>
        <li>Remplissez : mot (en majuscules), d√©finition, genre, nature, image</li>
        <li>Cliquez sur <strong>Enregistrer</strong></li>
      </ol>
      <div class="guide-tip">üí° Les sons sont g√©n√©r√©s automatiquement. Vous pouvez les corriger manuellement si besoin.</div>

      <h3>5. Importer depuis Excel</h3>
      <p>La m√©thode la plus rapide pour de nombreux mots. Votre fichier doit avoir ces colonnes :</p>
      <table class="guide-table">
        <tr><th>Col.</th><th>Contenu</th><th>Exemple</th></tr>
        <tr><td><strong>A</strong></td><td>Num√©ro</td><td>1</td></tr>
        <tr><td><strong>B</strong></td><td>Mot (majuscules)</td><td>AMOUREUX</td></tr>
        <tr><td><strong>C</strong></td><td>D√©finition</td><td>C'est quelqu'un qui aime‚Ä¶</td></tr>
        <tr><td><strong>D</strong></td><td>Genre</td><td>masc / fem / none</td></tr>
        <tr><td><strong>E</strong></td><td>Nature</td><td>nom / verbe / adjectif / autre</td></tr>
        <tr><td><strong>F</strong></td><td>Image <em>(optionnel)</em></td><td>laisser vide</td></tr>
        <tr><td><strong>G</strong></td><td>Segmentation <em>(optionnel)</em></td><td>a-mou-reux</td></tr>
        <tr><td><strong>H</strong></td><td>Liaisons <em>(optionnel)</em></td><td>ou;eu</td></tr>
        <tr><td><strong>I</strong></td><td>Couleurs <em>(optionnel)</em></td><td>ou=rouge</td></tr>
      </table>
      <p>Pour importer : <strong>‚¨ÜÔ∏è Import</strong> ‚Üí <strong>üì• Importer depuis Excel</strong> ‚Üí choisir le fichier ‚Üí remplir le nom de s√©rie et le num√©ro de dossier ‚Üí <strong>Importer</strong>.</p>

      <h3>6. Corriger les sons d'un mot</h3>
      <ol>
        <li>Dans l'√©diteur, cliquez sur le mot</li>
        <li>Section <strong>Sons</strong> : modifiez son, image, liaison de chaque groupe</li>
        <li>Utilisez <strong>‚äï</strong> pour fusionner deux groupes, <strong>‚äó</strong> pour s√©parer</li>
        <li>Cliquez sur <strong>Enregistrer</strong></li>
      </ol>

      <h3>7. Partager avec vos coll√®gues</h3>
      <ol>
        <li><strong>‚¨áÔ∏è Export</strong> ‚Üí <strong>üì§ G√©n√©rer series_partagees.json</strong></li>
        <li>Lancez <code>MAJ_VERSION.bat</code> (Windows) ou <code>MAJ_VERSION.sh</code> (Mac)</li>
        <li>D√©posez les deux fichiers sur GitHub</li>
      </ol>
      <p>Vos coll√®gues voient les nouvelles s√©ries automatiquement, sans Ctrl+F5.</p>
      <p>Pour <strong>supprimer</strong> une s√©rie partag√©e : bouton üóë sur sa carte ‚Üí d√©poser le fichier t√©l√©charg√© sur GitHub.</p>

      <h3>8. Questions fr√©quentes</h3>
      <div class="guide-faq">
        <div class="guide-q">‚ùì Les nouveaut√©s n'apparaissent pas</div>
        <div class="guide-a">Attendez 5 minutes (mise √† jour automatique) ou faites <kbd>Ctrl + F5</kbd>.</div>
        <div class="guide-q">‚ùì Mes s√©ries ont disparu</div>
        <div class="guide-a">Elles sont dans votre navigateur. Exportez-les r√©guli√®rement (bouton ‚¨áÔ∏è sur chaque carte) pour les sauvegarder.</div>
        <div class="guide-q">‚ùì Les images ne s'affichent pas</div>
        <div class="guide-a">V√©rifiez que l'image est sur GitHub dans le bon dossier et que le chemin correspond exactement (majuscules, accents‚Ä¶).</div>
        <div class="guide-q">‚ùì Un mot s'affiche en CAPITALES au lieu de scriptes</div>
        <div class="guide-a">Au lancement, choisissez <strong>Scriptes</strong> ‚Äî les lettres accentu√©es seront converties automatiquement.</div>
        <div class="guide-q">‚ùì Quelque chose ne fonctionne pas</div>
        <div class="guide-a">Essayez <kbd>F5</kbd> puis <kbd>Ctrl + F5</kbd>. Si le probl√®me persiste, notez le nom du mot et de la s√©rie et contactez votre coordinatrice.</div>
      </div>

    </div>
    <div style="text-align:center;margin-top:24px">
      <button class="btn bor" type="button" onclick="closeModal('m-guide')">Fermer</button>
    </div>
  </div>
</div>

</body>
</html>
